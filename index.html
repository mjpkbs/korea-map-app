<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국지도 웹앱</title>
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            font-weight: 600;
        }

        .control-item {
            margin-bottom: 12px;
        }

        .control-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        .admin-level-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .admin-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .admin-btn:hover {
            background: #f0f0f0;
        }

        .admin-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .color-item {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-item:hover {
            border-color: #333;
            transform: scale(1.1);
        }

        .color-item.selected {
            border-color: #007bff;
            border-width: 3px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-buttons .btn {
            width: 100%;
        }

        .route-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .route-toggle.active {
            background: #dc3545;
        }

        .selected-info {
            background: #e7f3ff;
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .selected-info h4 {
            margin: 0 0 5px 0;
            color: #007bff;
        }

        .selected-list {
            max-height: 100px;
            overflow-y: auto;
            font-size: 11px;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
                order: 2;
            }
            
            #map {
                height: 60vh;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>한국지도 설정</h2>
            
            <!-- 행정구역 레벨 선택 -->
            <div class="control-group">
                <h3>행정구역 레벨</h3>
                <div class="admin-level-selector">
                    <button class="admin-btn active" data-level="sido">시도</button>
                    <button class="admin-btn" data-level="sigungu">시군구</button>
                    <button class="admin-btn" data-level="emd">읍면동</button>
                </div>
            </div>
            
            <!-- 지도 스타일 선택 -->
            <div class="control-group">
                <h3>지도 스타일</h3>
                <div class="control-item">
                    <label for="mapStyle">스타일 선택:</label>
                    <select id="mapStyle">
                        <option value="mapbox://styles/mmjjpp/cmfqi0c3200f301r8cgqrfv62" selected>Basic Map</option>
                        <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                        <option value="mapbox://styles/kbsnews/cmd3179oj00q801ri8qrd2dl8">KBS 스타일 1</option>
                        <option value="mapbox://styles/kbsnews/clsle8lhq008101rbgzbm0x8q">KBS 스타일 2</option>
                    </select>
                </div>
            </div>

            <!-- 색상 설정 -->
            <div class="control-group">
                <h3>색상 설정</h3>
                <div class="control-item">
                    <label for="oceanColor">바다색:</label>
                    <input type="color" id="oceanColor" value="#0f3564">
                </div>
                <div class="control-item">
                    <label for="landColor">육지색:</label>
                    <input type="color" id="landColor" value="#8896a1">
                </div>
                <div class="control-item">
                    <label for="borderColor">경계선색:</label>
                    <input type="color" id="borderColor" value="#ffffff">
                </div>
            </div>

            <!-- 국가 경계선 설정 -->
            <div class="control-group">
                <h3>국가 경계선</h3>
                <div class="control-item">
                    <label for="countryBorderWidth">경계선 굵기:</label>
                    <div class="slider-container">
                        <input type="range" id="countryBorderWidth" min="1" max="10" value="3">
                        <span class="slider-value" id="countryBorderValue">3</span>
                    </div>
                </div>
                <div class="control-item">
                    <label>
                        <input type="checkbox" id="countryBorderDashed"> 점선으로 표시
                    </label>
                </div>
            </div>

            <!-- 행정구역 경계선 설정 -->
            <div class="control-group">
                <h3>행정구역 경계선</h3>
                <div class="control-item">
                    <label for="adminBorderWidth">경계선 굵기:</label>
                    <div class="slider-container">
                        <input type="range" id="adminBorderWidth" min="1" max="8" value="2">
                        <span class="slider-value" id="adminBorderValue">2</span>
                    </div>
                </div>
                <div class="control-item">
                    <label>
                        <input type="checkbox" id="adminBorderDashed"> 점선으로 표시
                    </label>
                </div>
            </div>

            <!-- 라벨 설정 -->
            <div class="control-group">
                <h3>라벨 설정</h3>
                <div class="control-item">
                    <label>
                        <input type="checkbox" id="showLabels" checked> 행정구역 이름 표시
                    </label>
                </div>
                <div class="control-item">
                    <label>
                        <input type="checkbox" id="showWater" checked> 강/호수 표시
                    </label>
                </div>
            </div>

            <!-- 행정구역 색상 선택 -->
            <div class="control-group">
                <h3>행정구역 색상</h3>
                <div class="control-item">
                    <label for="regionColor">선택된 구역 색상:</label>
                    <input type="color" id="regionColor" value="#7faef5">
                </div>
                <div class="color-palette" id="colorPalette"></div>
                <div class="control-item">
                    <button class="btn btn-secondary" id="clearSelection">선택 해제</button>
                </div>
                <div class="selected-info" id="selectedInfo">
                    <h4>선택된 구역</h4>
                    <p>선택된 구역이 없습니다</p>
                </div>
            </div>

            <!-- 경로 그리기 -->
            <div class="control-group">
                <h3>경로 그리기</h3>
                <div class="route-controls">
                    <button class="btn btn-secondary route-toggle" id="toggleRoute">경로 그리기</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-danger" id="clearRoute" style="width: 100%;">경로 지우기</button>
                </div>
            </div>

            <!-- 내보내기 -->
            <div class="control-group">
                <h3>내보내기</h3>
                <div class="export-buttons">
                    <button class="btn btn-primary" id="exportPNG">지도 PNG로 저장</button>
                    <button class="btn btn-primary" id="exportSVG">선택 구역 SVG로 저장</button>
                    <button class="btn btn-secondary" id="exportRoute">경로 SVG로 저장</button>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // ============================================================================
        // KOREA MAP APP - Clean Version
        // ============================================================================

        // Set your Mapbox access token here
        mapboxgl.accessToken = 'pk.eyJ1IjoibW1qanBwIiwiYSI6ImNtZmZnM3RwODBoYnEya3B6bnB3NW5zcHQifQ.6UON_8x8X84bxsCrURuggA';

        // Global variables
        let map;
        let selectedRegions = [];
        let isDrawingRoute = false;
        let routePoints = [];
        let currentAdminLevel = 'sido';

        // Color palette
        const colorPalette = [
            '#d6dade', '#b4bdc6', '#8896a1', '#546072', '#3c434f', '#242634',
            '#7faef5', '#5a8edb', '#2f62af', '#1f4e95', '#0f3564', '#172c4d',
            '#20ae98', '#22cc92', '#dd6f2d', '#f17d38', '#859cc1'
        ];

        // Layer configuration
        const layerConfig = {
            sido: { id: 'korea-sido', name: '시도', fillOpacity: 0.3, borderWidth: 3 },
            sigungu: { id: 'korea-sigungu', name: '시군구', fillOpacity: 0.4, borderWidth: 2 },
            emd: { id: 'korea-emd', name: '읍면동', fillOpacity: 0.5, borderWidth: 1 }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing map...');
            
            if (typeof mapboxgl === 'undefined') {
                alert('Mapbox GL JS 라이브러리를 로드할 수 없습니다.');
                return;
            }

            if (!mapboxgl.accessToken || mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
                alert('Mapbox access token을 설정해주세요.');
                return;
            }

            initializeMap();
        });

        // Initialize map
        function initializeMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mmjjpp/cmfqi0c3200f301r8cgqrfv62',
                center: [127.7669, 35.9078],
                zoom: 6.5,
                maxBounds: [[120, 30], [135, 43]],
                preserveDrawingBuffer: true
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');

            map.on('load', function() {
                console.log('Map loaded successfully');
                initializeColorPalette();
                initializeControls();
                initializeGeocoder();
                loadGeoJsonData();
                showToast('지도가 성공적으로 로드되었습니다', 'success');
            });

            map.on('error', function(e) {
                console.error('Map error:', e);
                showError('지도 로드 중 오류: ' + e.error.message);
            });
        }

        // Load GeoJSON data
        async function loadGeoJsonData() {
            showLoading(true);
            
            try {
                console.log('Loading GeoJSON files...');
                
                const timestamp = Date.now();
                const [sidoResponse, sigunguResponse, emdResponse] = await Promise.all([
                    fetch(`./data/sido.geojson?t=${timestamp}`),
                    fetch(`./data/sigungu.geojson?t=${timestamp}`),
                    fetch(`./data/emd.geojson?t=${timestamp}`)
                ]);
                
                if (!sidoResponse.ok) throw new Error(`Failed to load sido.geojson: ${sidoResponse.status}`);
                if (!sigunguResponse.ok) throw new Error(`Failed to load sigungu.geojson: ${sigunguResponse.status}`);
                if (!emdResponse.ok) throw new Error(`Failed to load emd.geojson: ${emdResponse.status}`);
                
                const [sidoData, sigunguData, emdData] = await Promise.all([
                    sidoResponse.json(),
                    sigunguResponse.json(),
                    emdResponse.json()
                ]);
                
                console.log('GeoJSON loaded - Sido:', sidoData.features.length, 'Sigungu:', sigunguData.features.length, 'Emd:', emdData.features.length);
                
                window.koreaData = { sido: sidoData, sigungu: sigunguData, emd: emdData };
                
                addGeoJsonSources();
                addGeoJsonLayers();
                setupMapInteractions();
                
                showToast(`데이터 로드 완료 (시도: ${sidoData.features.length}, 시군구: ${sigunguData.features.length}, 읍면동: ${emdData.features.length})`, 'success');
                
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                showError(`GeoJSON 로드 실패: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Add GeoJSON sources
        function addGeoJsonSources() {
            ['sido', 'sigungu', 'emd'].forEach(level => {
                if (map.getSource(`korea-${level}-source`)) {
                    map.removeSource(`korea-${level}-source`);
                }
            });

            const { sido, sigungu, emd } = window.koreaData;
            map.addSource('korea-sido-source', { type: 'geojson', data: sido });
            map.addSource('korea-sigungu-source', { type: 'geojson', data: sigungu });
            map.addSource('korea-emd-source', { type: 'geojson', data: emd });
        }

        // Add GeoJSON layers
        function addGeoJsonLayers() {
            Object.keys(layerConfig).forEach(level => {
                const config = layerConfig[level];
                
                if (!map.getSource(`korea-${level}-source`)) return;
                
                // Fill layer
                map.addLayer({
                    id: config.id + '-fill',
                    type: 'fill',
                    source: `korea-${level}-source`,
                    paint: {
                        'fill-color': '#8896a1',
                        'fill-opacity': config.fillOpacity
                    }
                });

                // Border layer
                map.addLayer({
                    id: config.id + '-border',
                    type: 'line',
                    source: `korea-${level}-source`,
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': config.borderWidth,
                        'line-opacity': 0.8
                    }
                });

                // Label layer
                let textField;
                switch(level) {
                    case 'sido': textField = ['get', 'SIDO_NM']; break;
                    case 'sigungu': textField = ['get', 'SIGUNGU_NM']; break;
                    case 'emd': textField = ['get', 'ADM_NM']; break;
                    default: textField = ['get', 'ADM_NM'];
                }

                map.addLayer({
                    id: config.id + '-labels',
                    type: 'symbol',
                    source: `korea-${level}-source`,
                    layout: {
                        'text-field': textField,
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-size': level === 'sido' ? 14 : level === 'sigungu' ? 12 : 10,
                        'text-anchor': 'center'
                    },
                    paint: {
                        'text-color': '#333333',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    }
                });

                // Hide non-sido layers initially
                if (level !== 'sido') {
                    map.setLayoutProperty(config.id + '-fill', 'visibility', 'none');
                    map.setLayoutProperty(config.id + '-border', 'visibility', 'none');
                    map.setLayoutProperty(config.id + '-labels', 'visibility', 'none');
                } else {
                    // Show sido labels only if checkbox is checked
                    const showLabels = document.getElementById('showLabels').checked;
                    map.setLayoutProperty(config.id + '-labels', 'visibility', showLabels ? 'visible' : 'none');
                }
            });

            // Setup colors after layer creation
            setTimeout(setupColorExpressions, 100);
        }

        // Setup color expressions
        function setupColorExpressions() {
            Object.keys(layerConfig).forEach(level => {
                const layerId = layerConfig[level].id + '-fill';
                if (map.getLayer(layerId)) {
                    try {
                        map.setPaintProperty(layerId, 'fill-color', [
                            'case',
                            ['boolean', ['feature-state', 'selected'], false],
                            '#7faef5',
                            '#8896a1'
                        ]);
                    } catch (error) {
                        console.warn('Color expression failed for', level);
                    }
                }
            });
        }

        // Initialize color palette
        function initializeColorPalette() {
            const container = document.getElementById('colorPalette');
            container.innerHTML = '';
            
            colorPalette.forEach(color => {
                const item = document.createElement('div');
                item.className = 'color-item';
                item.style.backgroundColor = color;
                item.addEventListener('click', () => selectColor(color, item));
                container.appendChild(item);
            });
        }

        // Initialize geocoder
        function initializeGeocoder() {
            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                countries: 'kr',
                language: 'ko',
                placeholder: '주소나 장소명을 검색하세요...'
            });
            map.addControl(geocoder, 'top-left');
        }

        // Initialize controls
        function initializeControls() {
            // Admin level buttons
            document.querySelectorAll('.admin-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchAdminLevel(e.target.dataset.level);
                });
            });

            // Map style
            document.getElementById('mapStyle').addEventListener('change', function(e) {
                map.setStyle(e.target.value);
                map.once('styledata', () => {
                    setTimeout(() => {
                        if (window.koreaData) {
                            addGeoJsonSources();
                            addGeoJsonLayers();
                            setupMapInteractions();
                            switchAdminLevel(currentAdminLevel);
                        }
                    }, 500);
                });
            });

            // Sliders
            document.getElementById('countryBorderWidth').addEventListener('input', function(e) {
                document.getElementById('countryBorderValue').textContent = e.target.value;
            });

            document.getElementById('adminBorderWidth').addEventListener('input', function(e) {
                document.getElementById('adminBorderValue').textContent = e.target.value;
            });

            // Colors
            document.getElementById('oceanColor').addEventListener('change', updateMapColors);
            document.getElementById('landColor').addEventListener('change', updateMapColors);
            document.getElementById('borderColor').addEventListener('change', updateBorderColor);
            document.getElementById('regionColor').addEventListener('change', updateSelectedRegionColors);

            // Checkboxes
            document.getElementById('showLabels').addEventListener('change', updateLabelVisibility);

            // Buttons
            document.getElementById('exportPNG').addEventListener('click', exportMapAsPNG);
            document.getElementById('exportSVG').addEventListener('click', exportSelectedRegionsAsSVG);
            document.getElementById('exportRoute').addEventListener('click', exportRouteAsSVG);
            document.getElementById('clearSelection').addEventListener('click', clearRegionSelection);
            document.getElementById('toggleRoute').addEventListener('click', toggleRouteDrawing);
            document.getElementById('clearRoute').addEventListener('click', clearRoute);
        }

        // Setup map interactions
        function setupMapInteractions() {
            Object.keys(layerConfig).forEach(level => {
                const layerId = layerConfig[level].id + '-fill';

                map.on('click', layerId, (e) => {
                    if (isDrawingRoute) {
                        addRoutePoint(e.lngLat);
                        return;
                    }
                    
                    toggleRegionSelection(e.features[0], level);
                });

                map.on('mouseenter', layerId, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layerId, () => {
                    map.getCanvas().style.cursor = '';
                });
            });

            map.on('click', (e) => {
                if (isDrawingRoute && !e.defaultPrevented) {
                    addRoutePoint(e.lngLat);
                }
            });
        }

        // Switch admin level
        function switchAdminLevel(level) {
            currentAdminLevel = level;
            
            document.querySelectorAll('.admin-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
            
            // Hide all layers first
            Object.keys(layerConfig).forEach(layerLevel => {
                const config = layerConfig[layerLevel];
                if (map.getLayer(config.id + '-fill')) {
                    map.setLayoutProperty(config.id + '-fill', 'visibility', 'none');
                    map.setLayoutProperty(config.id + '-border', 'visibility', 'none');
                    map.setLayoutProperty(config.id + '-labels', 'visibility', 'none');
                }
            });
            
            // Show selected level
            const config = layerConfig[level];
            if (map.getLayer(config.id + '-fill')) {
                map.setLayoutProperty(config.id + '-fill', 'visibility', 'visible');
                map.setLayoutProperty(config.id + '-border', 'visibility', 'visible');
                
                const showLabels = document.getElementById('showLabels').checked;
                map.setLayoutProperty(config.id + '-labels', 'visibility', showLabels ? 'visible' : 'none');
            }
            
            showToast(`${config.name} 레벨로 전환되었습니다`, 'success');
        }

        // Toggle region selection
        function toggleRegionSelection(feature, level) {
            const regionId = feature.properties.NF_ID || feature.id || Math.random().toString();
            
            let regionName;
            switch(level) {
                case 'sido': regionName = feature.properties.SIDO_NM || 'Unknown'; break;
                case 'sigungu': regionName = feature.properties.SIGUNGU_NM || 'Unknown'; break;
                case 'emd': regionName = feature.properties.ADM_NM || 'Unknown'; break;
                default: regionName = 'Unknown';
            }
            
            const existingIndex = selectedRegions.findIndex(r => r.id === regionId && r.level === level);
            
            if (existingIndex > -1) {
                selectedRegions.splice(existingIndex, 1);
                if (feature.id !== undefined) {
                    try {
                        map.setFeatureState(
                            { source: `korea-${level}-source`, id: feature.id },
                            { selected: false }
                        );
                    } catch (e) {}
                }
                showToast(`${regionName} 선택 해제됨`, 'success');
            } else {
                const selectedColor = document.getElementById('regionColor').value;
                selectedRegions.push({
                    id: regionId,
                    name: regionName,
                    level: level,
                    feature: feature,
                    color: selectedColor
                });
                
                if (feature.id !== undefined) {
                    try {
                        map.setFeatureState(
                            { source: `korea-${level}-source`, id: feature.id },
                            { selected: true }
                        );
                    } catch (e) {}
                }
                showToast(`${regionName} 선택됨`, 'success');
            }
            
            updateLayerColors();
            updateSelectedRegionsInfo();
        }

        // Select color
        function selectColor(color, item) {
            document.getElementById('regionColor').value = color;
            document.querySelectorAll('.color-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            updateSelectedRegionColors();
        }

        // Update functions
        function updateMapColors() {
            showToast('지도 색상 기능은 스타일에 따라 달라집니다', 'info');
        }

        function updateBorderColor() {
            const color = document.getElementById('borderColor').value;
            Object.keys(layerConfig).forEach(level => {
                const layerId = layerConfig[level].id + '-border';
                if (map.getLayer(layerId)) {
                    map.setPaintProperty(layerId, 'line-color', color);
                }
            });
        }

        function updateSelectedRegionColors() {
            const color = document.getElementById('regionColor').value;
            selectedRegions.forEach(region => {
                region.color = color;
            });
            updateLayerColors();
            updateSelectedRegionsInfo();
        }

        function updateLayerColors() {
            const selectedColor = document.getElementById('regionColor').value;
            Object.keys(layerConfig).forEach(level => {
                const layerId = layerConfig[level].id + '-fill';
                if (map.getLayer(layerId)) {
                    try {
                        map.setPaintProperty(layerId, 'fill-color', [
                            'case',
                            ['boolean', ['feature-state', 'selected'], false],
                            selectedColor,
                            '#8896a1'
                        ]);
                    } catch (e) {}
                }
            });
        }

        function updateLabelVisibility() {
            const show = document.getElementById('showLabels').checked;
            Object.keys(layerConfig).forEach(level => {
                const layerId = layerConfig[level].id + '-labels';
                if (map.getLayer(layerId)) {
                    const shouldShow = (show && level === currentAdminLevel) ? 'visible' : 'none';
                    map.setLayoutProperty(layerId, 'visibility', shouldShow);
                }
            });
        }

        function clearRegionSelection() {
            selectedRegions.forEach(region => {
                if (region.feature.id !== undefined) {
                    try {
                        map.setFeatureState(
                            { source: `korea-${region.level}-source`, id: region.feature.id },
                            { selected: false }
                        );
                    } catch (e) {}
                }
            });
            
            selectedRegions = [];
            updateSelectedRegionsInfo();
            updateLayerColors();
            showToast('모든 선택이 해제되었습니다', 'success');
        }

        function updateSelectedRegionsInfo() {
            const info = document.getElementById('selectedInfo');
            if (selectedRegions.length === 0) {
                info.innerHTML = '<h4>선택된 구역</h4><p>선택된 구역이 없습니다</p>';
            } else {
                let html = `<h4>선택된 구역 (${selectedRegions.length}개)</h4><div class="selected-list">`;
                selectedRegions.forEach(region => {
                    html += `<div style="color: ${region.color};">• ${region.name}</div>`;
                });
                html += '</div>';
                info.innerHTML = html;
            }
        }

        // Route functions
        function toggleRouteDrawing() {
            isDrawingRoute = !isDrawingRoute;
            const button = document.getElementById('toggleRoute');
            
            if (isDrawingRoute) {
                button.textContent = '경로 그리기 완료';
                button.classList.add('active');
                map.getCanvas().style.cursor = 'crosshair';
                showToast('지도를 클릭하여 경로를 그리세요', 'info');
            } else {
                button.textContent = '경로 그리기';
                button.classList.remove('active');
                map.getCanvas().style.cursor = '';
                showToast('경로 그리기가 완료되었습니다', 'success');
            }
        }

        function addRoutePoint(lngLat) {
            routePoints.push([lngLat.lng, lngLat.lat]);
            
            const marker = new mapboxgl.Marker({ color: '#ff0000' })
                .setLngLat([lngLat.lng, lngLat.lat])
                .addTo(map);
            
            if (!window.routeMarkers) window.routeMarkers = [];
            window.routeMarkers.push(marker);
            
            if (routePoints.length > 1) {
                updateRouteLine();
            }
            
            showToast(`경로 포인트 ${routePoints.length} 추가됨`, 'success');
        }

        function updateRouteLine() {
            const routeData = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: routePoints
                }
            };
            
            if (map.getSource('route')) {
                map.getSource('route').setData(routeData);
            } else {
                map.addSource('route', { type: 'geojson', data: routeData });
                map.addLayer({
                    id: 'route-line',
                    type: 'line',
                    source: 'route',
                    paint: {
                        'line-color': '#ff0000',
                        'line-width': 4,
                        'line-opacity': 0.8
                    }
                });
            }
        }

        function clearRoute() {
            routePoints = [];
            
            if (map.getLayer('route-line')) {
                map.removeLayer('route-line');
            }
            if (map.getSource('route')) {
                map.removeSource('route');
            }
            
            if (window.routeMarkers) {
                window.routeMarkers.forEach(marker => marker.remove());
                window.routeMarkers = [];
            }
            
            isDrawingRoute = false;
            const button = document.getElementById('toggleRoute');
            button.textContent = '경로 그리기';
            button.classList.remove('active');
            map.getCanvas().style.cursor = '';
            
            showToast('경로가 지워졌습니다', 'success');
        }

        // Export functions
        function exportMapAsPNG() {
            try {
                map.once('idle', () => {
                    setTimeout(() => {
                        const canvas = map.getCanvas();
                        const link = document.createElement('a');
                        link.download = `korea-map-${Date.now()}.png`;
                        link.href = canvas.toDataURL('image/png', 1.0);
                        link.click();
                        showToast('지도가 PNG로 저장되었습니다', 'success');
                    }, 500);
                });
                map.triggerRepaint();
            } catch (error) {
                showError('PNG 내보내기 중 오류가 발생했습니다');
            }
        }

        function exportSelectedRegionsAsSVG() {
            if (selectedRegions.length === 0) {
                showToast('선택된 구역이 없습니다', 'info');
                return;
            }
            showToast('SVG 내보내기 기능은 개발 중입니다', 'info');
        }

        function exportRouteAsSVG() {
            if (routePoints.length < 2) {
                showToast('경로가 설정되지 않았습니다', 'info');
                return;
            }
            showToast('경로 SVG 내보내기 기능은 개발 중입니다', 'info');
        }

        // Utility functions
        function showLoading(show) {
            let loader = document.getElementById('loadingIndicator');
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'loadingIndicator';
                    loader.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    background: white; padding: 20px; border-radius: 8px; 
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2000; text-align: center;">
                            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; 
                                        border-top: 4px solid #007bff; border-radius: 50%; 
                                        animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                            <div>데이터를 로드하는 중...</div>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;
                    document.body.appendChild(loader);
                }
                loader.style.display = 'block';
            } else {
                if (loader) loader.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; 
                padding: 12px 20px; border-radius: 4px; color: white; 
                z-index: 3000; max-width: 300px; font-size: 14px;
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            
            switch(type) {
                case 'success': toast.style.backgroundColor = '#28a745'; break;
                case 'error': toast.style.backgroundColor = '#dc3545'; break;
                case 'info': toast.style.backgroundColor = '#007bff'; break;
                default: toast.style.backgroundColor = '#333';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function showError(message) {
            console.error(message);
            showToast(message, 'error');
        }
    </script>
</body>
</html>
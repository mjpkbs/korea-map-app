<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>한국 지도 — Mapbox 대용량 GeoJSON & 런타임 스타일 (Fixed)</title>

  <!-- ✅ 공식 Mapbox CDN (CSS/JS) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- ✅ Geocoder 플러그인 (CSS/JS) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>

  <!-- 작은 파비콘(404 방지) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%20viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%230f3564'/%3E%3C/svg%3E">

  <style>
    :root{ --bg:#0b0f14; --panel:#11161d; --muted:#9fb0c3; --accent:#2eaadc; --border:#1f2a36; --text:#e6eef7; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
    #app{display:grid;grid-template-columns:360px 1fr;height:100%}
    #panel{background:var(--panel);border-right:1px solid var(--border);padding:14px 14px 18px;overflow:auto}
    #map{position:relative}
    #mapContainer{width:100%;height:100%}
    h1{font-size:18px;margin:0 0 8px 0}
    h2{font-size:13px;margin:10px 0;color:var(--muted);font-weight:700;letter-spacing:.4px}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input[type="text"], input[type="number"], select{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:10px;background:#0c1218;color:var(--text);outline:none}
    input[type="color"]{width:100%;height:38px;border:1px solid var(--border);border-radius:10px;background:#0c1218}
    input[type="range"]{width:100%}
    .row{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{background:#13202c;border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn:hover{background:#0f1a24}
    .ghost{background:transparent}
    .section{background:#0c1218;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
    .inline{display:flex;gap:10px;align-items:center}
    .switch{display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px}
    #status{font-size:12px;color:#b8c7d8;line-height:1.5}
    .floating{position:absolute;top:10px;left:10px;z-index:5}
    .toast{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;padding:8px 10px;border-radius:8px;z-index:10;display:none}
  </style>
</head>
<body>
<div id="app">
  <aside id="panel">
    <h1>한국 지도 앱 — Mapbox</h1>
    <div class="section">
      <label>Mapbox Access Token</label>
      <input id="token" type="text" placeholder="본인 Access Token을 입력하세요" />
      <div class="two" style="margin-top:8px">
        <button class="btn" id="initMap" disabled>지도 초기화</button>
        <button class="btn ghost" id="saveToken">토큰 저장</button>
      </div>
      <div class="muted small" style="margin-top:6px">* 토큰은 localStorage에 저장됩니다.</div>
      <div id="libStatus" class="muted small" style="margin-top:6px">라이브러리 로딩 중…</div>
    </div>

    <div class="section">
      <h2>검색</h2>
      <div class="muted small">좌측 상단 검색창(Geocoder)에서 주소/장소 검색 → 자동 줌</div>
    </div>

    <div class="section">
      <h2>행정구역 레벨 (대용량 대응: ON 때만 로드)</h2>
      <div class="switch"><span>시도</span><input type="checkbox" id="chkSido"></div>
      <div class="switch"><span>시군구</span><input type="checkbox" id="chkSigungu"></div>
      <div class="switch"><span>읍면동</span><input type="checkbox" id="chkEmd"></div>
      <div class="muted small" style="margin-top:6px">* 켜면 해당 GeoJSON을 fetch→소스/레이어 추가, 끄면 제거하여 메모리 절약</div>
    </div>

    <div class="section">
      <h2>라벨</h2>
      <div class="switch"><span>Mapbox 기본 라벨</span><input type="checkbox" id="chkBaseLabels" checked></div>
      <div class="switch"><span>행정 라벨(우리 데이터)</span><input type="checkbox" id="chkOurLabels" checked></div>
      <div class="muted small" style="margin-top:6px">* 기본 라벨은 스타일 심볼 레이어를 휴리스틱으로 제어(스타일에 따라 일부 예외 가능)</div>
    </div>

    <div class="section">
      <h2>런타임 스타일</h2>
      <div class="row">
        <div><label>바다색</label><input type="color" id="waterColor" value="#0f3564"></div>
        <div><label class="small">불투명도</label><input type="range" id="waterOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div class="row">
        <div><label>육지색</label><input type="color" id="landColor" value="#8896a1"></div>
        <div><label class="small">불투명도</label><input type="range" id="landOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div><label>경계선색</label><input type="color" id="boundaryColor" value="#ffffff"></div>
      <div class="row"><label>나라 경계선 굵기(px)</label><input type="range" id="countryWidth" min="0.5" max="6" step="0.1" value="1.5"></div>
      <div class="inline"><input type="checkbox" id="countryDashed"><label for="countryDashed">나라 경계선 점선</label></div>
      <div class="row" style="margin-top:8px"><label>행정 경계선 굵기(px)</label><input type="range" id="adminWidth" min="0.5" max="6" step="0.1" value="1.0"></div>
      <div class="inline"><input type="checkbox" id="adminDashed"><label for="adminDashed">행정 경계선 점선</label></div>
    </div>

    <div class="section">
      <h2>선택 영역 색칠</h2>
      <label>선택 색</label><input type="color" id="selectColor" value="#ffcc33">
      <div class="inline" style="margin-top:6px"><input type="checkbox" id="selectHalf" checked><label for="selectHalf">반투명</label></div>
      <div class="two" style="margin-top:8px">
        <button class="btn" id="clearSelection">선택 해제</button>
        <button class="btn ghost" id="exportSelection">GeoJSON 내보내기</button>
      </div>
      <div class="muted small" style="margin-top:6px">* 지도에서 채움 레이어를 클릭해 다중 선택</div>
    </div>

    <div class="section">
      <h2>PNG 저장</h2>
      <button class="btn" id="savePng">현재 화면 PNG로 저장</button>
      <div class="muted small" style="margin-top:6px">* 화면 크기 그대로 저장합니다.</div>
    </div>

    <div class="section">
      <h2>상태</h2>
      <div id="status">라이브러리 로딩 대기 중…</div>
    </div>
  </aside>

  <main id="map">
    <div id="geocoderMount" class="floating"></div>
    <div id="mapContainer"></div>
    <div id="toast" class="toast"></div>
  </main>
</div>

<script>
(function(){
  const els = {
    token: document.getElementById('token'),
    initMap: document.getElementById('initMap'),
    saveToken: document.getElementById('saveToken'),
    geocoderMount: document.getElementById('geocoderMount'),
    status: document.getElementById('status'),
    libStatus: document.getElementById('libStatus'),
    toast: document.getElementById('toast'),

    chkSido: document.getElementById('chkSido'),
    chkSigungu: document.getElementById('chkSigungu'),
    chkEmd: document.getElementById('chkEmd'),
    chkBaseLabels: document.getElementById('chkBaseLabels'),
    chkOurLabels: document.getElementById('chkOurLabels'),

    waterColor: document.getElementById('waterColor'),
    waterOpacity: document.getElementById('waterOpacity'),
    landColor: document.getElementById('landColor'),
    landOpacity: document.getElementById('landOpacity'),
    boundaryColor: document.getElementById('boundaryColor'),
    countryWidth: document.getElementById('countryWidth'),
    adminWidth: document.getElementById('adminWidth'),
    countryDashed: document.getElementById('countryDashed'),
    adminDashed: document.getElementById('adminDashed'),

    selectColor: document.getElementById('selectColor'),
    selectHalf: document.getElementById('selectHalf'),
    clearSelection: document.getElementById('clearSelection'),
    exportSelection: document.getElementById('exportSelection'),

    savePng: document.getElementById('savePng'),
  };

  const STORE = 'kr-map-index';
  const FILES = { sido:'sido.geojson', sigungu:'sigungu.geojson', emd:'emd.geojson' };
  const FIELDS = { sido:'SIDO_NM', sigungu:'SIGUNGU_NM', emd:'ADM_NM' };

  let map = null;
  let detected = null;
  const selection = new Map();
  let selectionSourceReady = false;

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    setTimeout(()=> els.toast.style.display='none', 2200);
  }
  function setStatus(msg){ els.status.textContent = msg; }

  function saveLocal(){ localStorage.setItem(STORE, JSON.stringify({ token: els.token.value.trim() })); }
  function loadLocal(){ try{ const d=JSON.parse(localStorage.getItem(STORE)||'{}'); if(d.token) els.token.value=d.token; }catch{} }

  // ✅ 라이브러리 로드 확인 후 버튼 활성화
  function checkLibReady(){
    const ok = !!(window.mapboxgl && window.MapboxGeocoder);
    els.libStatus.textContent = ok ? '라이브러리 로드 완료' : '라이브러리 로딩 실패… 새로고침(Ctrl/Cmd+Shift+R) 해보세요';
    els.initMap.disabled = !ok;
  }

  // 최초 로딩 상태 확인 (일부 브라우저는 비동기로 늦게 잡힐 수 있어 반복 체크)
  let tries = 0;
  const t = setInterval(()=>{
    tries++;
    checkLibReady();
    if(els.initMap.disabled && tries < 30) return;
    clearInterval(t);
  }, 200);

  // 이벤트 바인딩
  function bindUI(){
    els.initMap.addEventListener('click', createMap);
    els.saveToken.addEventListener('click', ()=>{ saveLocal(); toast('토큰 저장됨'); });

    els.chkSido.addEventListener('change', ()=> toggleLevel('sido', els.chkSido.checked));
    els.chkSigungu.addEventListener('change', ()=> toggleLevel('sigungu', els.chkSigungu.checked));
    els.chkEmd.addEventListener('change', ()=> toggleLevel('emd', els.chkEmd.checked));

    els.chkBaseLabels.addEventListener('change', ()=> toggleBaseLabels(els.chkBaseLabels.checked));
    els.chkOurLabels.addEventListener('change', applyOurLabelsVisibility);

    [els.waterColor, els.waterOpacity, els.landColor, els.landOpacity, els.boundaryColor,
     els.countryWidth, els.adminWidth, els.countryDashed, els.adminDashed]
    .forEach(el => el.addEventListener('input', applyRuntimeColors));

    els.selectColor.addEventListener('input', updateSelectionStyle);
    els.selectHalf.addEventListener('change', updateSelectionStyle);
    els.clearSelection.addEventListener('click', clearSelection);
    els.exportSelection.addEventListener('click', exportSelectionGeoJSON);

    els.savePng.addEventListener('click', savePNG);
  }

  function createMap(){
    if(!window.mapboxgl){ toast('mapboxgl이 아직 준비되지 않았어요. 새로고침해 주세요.'); return; }
    const token = els.token.value.trim();
    if(!token){ toast('Access Token을 입력하세요.'); return; }
    saveLocal();

    mapboxgl.accessToken = token;
    if(map){ map.remove(); map=null; }

    map = new mapboxgl.Map({
      container: 'mapContainer',
      style: 'mapbox://styles/mapbox/standard',
      center: [127.8, 36.3],
      zoom: 6,
      locale: 'ko',
      preserveDrawingBuffer: true
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // Geocoder
    if(!window.MapboxGeocoder){ toast('Geocoder 플러그인이 준비되지 않았습니다.'); }
    else {
      const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, language:'ko,en', placeholder:'주소 또는 키워드 검색…' });
      els.geocoderMount.innerHTML='';
      els.geocoderMount.appendChild(geocoder.onAdd(map));
      geocoder.on('result', e=>{
        if(e.result?.bbox){ const b=e.result.bbox; map.fitBounds([[b[0],b[1]],[b[2],b[3]]], { padding:60, duration:900 }); }
        else if(e.result?.center){ map.flyTo({ center:e.result.center, zoom:14 }); }
      });
    }

    map.on('load', ()=>{
      detected = scanStyleLayers();
      setStatus('지도 로드됨 — 레벨을 켜서 GeoJSON을 불러오세요.');
      applyRuntimeColors();
      toggleBaseLabels(els.chkBaseLabels.checked);

      ensureSelectionSource();
      ensureSelectionLayer();
    });

    map.on('style.load', ()=>{
      detected = scanStyleLayers();
      applyRuntimeColors();
      toggleBaseLabels(els.chkBaseLabels.checked);
      applyOurLabelsVisibility();

      if(els.chkSido.checked) addLevel('sido');
      if(els.chkSigungu.checked) addLevel('sigungu');
      if(els.chkEmd.checked) addLevel('emd');

      ensureSelectionSource();
      ensureSelectionLayer();
      updateSelectionStyle();
    });
  }

  function scanStyleLayers(){
    const found = { water:[], landBg:[], landFill:[], boundary:[], baseLabelIds:[] };
    const layers = (map.getStyle()?.layers)||[];
    layers.forEach(l=>{
      const id=(l.id||'').toLowerCase(); const srcLayer=(l['source-layer']||'').toLowerCase();
      if(l.type==='background') found.landBg.push(l.id);
      if(/water|ocean|sea/.test(id+' '+srcLayer)){ if(['fill','line','background'].includes(l.type)) found.water.push(l.id); }
      if(l.type==='fill' && /land|landcover|landuse|earth|natural/.test(id+' '+srcLayer)){ found.landFill.push(l.id); }
      if(l.type==='line' && /admin|boundary|borders|country/.test(id+' '+srcLayer)){ found.boundary.push(l.id); }
      if(l.type==='symbol'){ if(!/(^|-)sido-label|sigungu-label|emd-label/.test(id)) found.baseLabelIds.push(l.id); }
    });
    return found;
  }
  function trySet(layerId, prop, val){ try{ map.setPaintProperty(layerId, prop, val); }catch{} }
  function tryLayout(layerId, prop, val){ try{ map.setLayoutProperty(layerId, prop, val); }catch{} }

  async function toggleLevel(lvl, on){
    if(!map) return;
    if(on) await addLevel(lvl); else removeLevel(lvl);
    applyOurLabelsVisibility(); applyRuntimeColors();
  }
  async function addLevel(lvl){
    const src=`${lvl}-src`, fill=`${lvl}-fill`, line=`${lvl}-line`, label=`${lvl}-label`;
    if(!map.getSource(src)){ map.addSource(src, { type:'geojson', data: FILES[lvl], promoteId: FIELDS[lvl] }); }
    if(!map.getLayer(fill)){ map.addLayer({ id:fill, type:'fill', source:src, paint:{ 'fill-color':'#ffffff','fill-opacity':0.03 } }, firstSymbolId()); }
    if(!map.getLayer(line)){ map.addLayer({ id:line, type:'line', source:src, paint:{ 'line-color': els.boundaryColor.value, 'line-width': parseFloat(els.adminWidth.value), 'line-dasharray': els.adminDashed.checked?[2,2]:[1,0] } }); }
    if(!map.getLayer(label)){ map.addLayer({ id:label, type:'symbol', source:src, layout:{ 'text-field':['get', FIELDS[lvl]], 'text-size':['interpolate',['linear'],['zoom'],6,9,10,12,14,16] }, paint:{ 'text-color':'#1f2940','text-halo-color':'#fff','text-halo-width':1.2,'text-opacity': els.chkOurLabels.checked?1:0 } }); }
    bindSelect(fill, lvl);
    setStatus(`로드됨: ${lvl}`);
  }
  function removeLevel(lvl){
    const fill=`${lvl}-fill`, line=`${lvl}-line`, label=`${lvl}-label`, src=`${lvl}-src`;
    [fill,line,label].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); });
    if(map.getSource(src)) map.removeSource(src);
    // 선택에서 해당 레벨 삭제
    [...selection.keys()].forEach(k=>{ if(k.startsWith(lvl+'|')) selection.delete(k); });
    refreshSelectionSourceData();
  }
  function firstSymbolId(){ const layers=map.getStyle()?.layers||[]; const sym=layers.find(l=>l.type==='symbol'); return sym?sym.id:undefined; }

  function toggleBaseLabels(show){
    if(!map || !detected) return;
    detected.baseLabelIds.forEach(id=> tryLayout(id,'visibility', show?'visible':'none'));
  }
  function applyRuntimeColors(){
    if(!map || !detected) return;
    const sea=els.waterColor.value, land=els.landColor.value, bcol=els.boundaryColor.value;
    const wOp=parseFloat(els.waterOpacity.value), lOp=parseFloat(els.landOpacity.value);
    const cW=parseFloat(els.countryWidth.value), aW=parseFloat(els.adminWidth.value);
    const cDashed=els.countryDashed.checked, aDashed=els.adminDashed.checked;

    if(detected.landBg.length){ detected.landBg.forEach(id=>{ trySet(id,'background-color',land); trySet(id,'background-opacity',lOp); }); }
    else{ detected.landFill.forEach(id=>{ trySet(id,'fill-color',land); trySet(id,'fill-opacity',lOp); }); }

    detected.water.forEach(id=>{
      const t = map.getLayer(id)?.type;
      if(t==='fill'){ trySet(id,'fill-color',sea); trySet(id,'fill-opacity',wOp); }
      else if(t==='line'){ trySet(id,'line-color',sea); trySet(id,'line-opacity',wOp); }
      else if(t==='background'){ trySet(id,'background-color',sea); trySet(id,'background-opacity',wOp); }
    });

    detected.boundary.forEach(id=>{ trySet(id,'line-color',bcol); trySet(id,'line-width',cW); trySet(id,'line-dasharray', cDashed?[2,2]:[1,0]); });

    ['sido-line','sigungu-line','emd-line'].forEach(id=>{
      if(map.getLayer(id)){ trySet(id,'line-color',bcol); trySet(id,'line-width',aW); trySet(id,'line-dasharray', aDashed?[2,2]:[1,0]); }
    });
  }
  function applyOurLabelsVisibility(){ const v=els.chkOurLabels.checked?1:0; ['sido-label','sigungu-label','emd-label'].forEach(id=>{ try{ map.setPaintProperty(id,'text-opacity',v); }catch{} }); }

  function ensureSelectionSource(){
    if(!map.getSource('selection-src')){ map.addSource('selection-src', { type:'geojson', data:{ type:'FeatureCollection', features:[] } }); }
    selectionSourceReady = true;
  }
  function ensureSelectionLayer(){
    if(!map.getLayer('selection-overlay')){
      map.addLayer({ id:'selection-overlay', type:'fill', source:'selection-src', paint:{ 'fill-color': els.selectColor.value, 'fill-opacity': els.selectHalf.checked?0.5:1.0 } }, firstSymbolId());
    }
  }
  function bindSelect(fillLayerId, lvl){
    if(!map.getLayer(fillLayerId)) return;
    map._bindSel = map._bindSel || {};
    if(map._bindSel[fillLayerId]) return;
    map.on('click', fillLayerId, (e)=>{
      const feats = map.queryRenderedFeatures(e.point, { layers:[fillLayerId] });
      if(!feats.length) return;
      const f=feats[0]; const name=f.properties?.[FIELDS[lvl]]; if(!name) return;
      const key=`${lvl}|${name}`;
      if(selection.has(key)) selection.delete(key); else selection.set(key, JSON.parse(JSON.stringify(f)));
      refreshSelectionSourceData();
      setStatus(`선택 개수: ${selection.size}`);
    });
    map.on('mouseenter', fillLayerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', fillLayerId, ()=> map.getCanvas().style.cursor='');
    map._bindSel[fillLayerId] = true;
  }
  function refreshSelectionSourceData(){
    if(!selectionSourceReady) return;
    const feats = Array.from(selection.values()).map(ft=>({ type:'Feature', geometry: ft.geometry, properties: ft.properties||{} }));
    map.getSource('selection-src').setData({ type:'FeatureCollection', features:feats });
  }
  function updateSelectionStyle(){
    if(!map || !map.getLayer('selection-overlay')) return;
    map.setPaintProperty('selection-overlay','fill-color', els.selectColor.value);
    map.setPaintProperty('selection-overlay','fill-opacity', els.selectHalf.checked?0.5:1.0);
  }
  function clearSelection(){ selection.clear(); refreshSelectionSourceData(); setStatus('선택 해제됨'); }
  function exportSelectionGeoJSON(){
    const data = map.getSource('selection-src')._data || { type:'FeatureCollection', features:[] };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/geo+json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='selection.geojson'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }

  function savePNG(){
    if(!map) return;
    const canvas = map.getCanvas();
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='map.png'; a.click();
  }

  // 부팅
  loadLocal();
  bindUI();
  checkLibReady();
})();
</script>
</body>
</html>

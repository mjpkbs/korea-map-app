<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>한국 지도 — Tilesets + 런타임 스타일 (Fixed)</title>

<!-- Mapbox (공식 CDN) -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>

<style>
  :root{ --bg:#0b0f14; --panel:#11161d; --muted:#9fb0c3; --border:#1f2a36; --text:#e6eef7; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Pretendard,'Apple SD Gothic Neo',Arial,sans-serif}
  #app{display:grid;grid-template-columns:360px 1fr;height:100%}
  #panel{background:#11161d;border-right:1px solid var(--border);padding:14px;overflow:auto}
  #map{position:relative}
  #mapContainer{width:100%;height:100%}
  h1{font-size:18px;margin:0 0 8px}
  h2{font-size:13px;margin:10px 0;color:var(--muted);font-weight:700;letter-spacing:.4px}
  label{display:block;font-size:13px;margin:8px 0 4px}
  input[type="text"]{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:10px;background:#0c1218;color:#e6eef7}
  input[type="color"]{width:100%;height:38px;border:1px solid var(--border);border-radius:10px;background:#0c1218}
  input[type="range"]{width:100%}
  .row{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{background:#13202c;border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600;font-size:12px}
  .btn:hover{background:#0f1a24}
  .btn-small{padding:6px 8px;font-size:11px}
  .ghost{background:transparent}
  .section{background:#0c1218;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
  .switch{display:flex;align-items:center;justify-content:space-between}
  .muted{color:var(--muted);font-size:12px}
  .floating{position:absolute;top:10px;left:10px;z-index:5}
  .toast{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;padding:8px 10px;border-radius:8px;z-index:10;display:none}

  .selector-container{margin-bottom:8px}
  .selector-input{position:relative}
  .selector-dropdown{position:absolute;top:100%;left:0;right:0;background:#0c1218;border:1px solid var(--border);border-radius:8px;max-height:200px;overflow-y:auto;z-index:20;display:none}
  .dropdown-item{padding:8px 10px;cursor:pointer;font-size:12px;color:#e6eef7}
  .dropdown-item:hover{background:#13202c}
  .selected-items{margin-top:8px}
  .selected-item{background:#13202c;border:1px solid var(--border);border-radius:6px;padding:4px 8px;margin:2px;display:inline-flex;align-items:center;font-size:11px}
  .selected-item .remove{margin-left:6px;color:#ff6b6b;cursor:pointer;font-weight:bold}

  .route-controls{margin-top:8px}
  .route-info{font-size:11px;color:var(--muted);margin-top:4px}

  /* Geocoder */
  .mapboxgl-ctrl-geocoder, .mapboxgl-ctrl-geocoder .suggestions{background:#0c1218 !important; color:#e6eef7 !important;}
  .mapboxgl-ctrl-geocoder input[type='text']{color:#e6eef7 !important;}
  .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input::placeholder{color:#9fb0c3 !important;}
  .mapboxgl-ctrl-geocoder .suggestions > li{color:#e6eef7 !important; background:#0c1218 !important;}
  .mapboxgl-ctrl-geocoder .suggestions > .active{background:#13202c !important;}

  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
</style>
</head>
<body>
<div id="app">
  <aside id="panel">
    <h1>한국 지도 앱 — Tilesets Vector</h1>

    <div class="section">
      <label>지도 상태</label>
      <div id="status">지도 로딩 중...</div>
    </div>

    <div class="section">
      <h2>행정구역 레벨 (타일셋)</h2>
      <div class="switch"><span>시도</span><input type="checkbox" id="chkSido" checked></div>
      <div class="switch"><span>시군구</span><input type="checkbox" id="chkSigungu"></div>
      <div class="switch"><span>읍면동</span><input type="checkbox" id="chkEmd"></div>
      <div class="muted" style="margin-top:6px">* 켜면 해당 타일셋 레이어 추가, 끄면 제거</div>
    </div>

    <div class="section">
      <h2>시군구 선택</h2>
      <label>시군구 선택 색</label>
      <input type="color" id="sigunguSelectColor" value="#ffcc33">
      <div class="selector-container" style="margin-top:8px">
        <div class="selector-input">
          <input type="text" id="sigunguSearch" placeholder="시군구 검색..." />
          <div id="sigunguDropdown" class="selector-dropdown"></div>
        </div>
        <div class="selected-items" id="selectedSigungu"></div>
        <button class="btn btn-small" id="refreshSigungu" style="margin-top:6px">데이터 새로고침</button>
        <button class="btn btn-small" id="testSigungu" style="margin-top:6px">검색 테스트</button>
      </div>
    </div>

    <div class="section">
      <h2>읍면동 선택</h2>
      <label>읍면동 선택 색</label>
      <input type="color" id="emdSelectColor" value="#33ccff">
      <div class="selector-container" style="margin-top:8px">
        <div class="selector-input">
          <input type="text" id="emdSearch" placeholder="읍면동 검색..." />
          <div id="emdDropdown" class="selector-dropdown"></div>
        </div>
        <div class="selected-items" id="selectedEmd"></div>
        <button class="btn btn-small" id="refreshEmd" style="margin-top:6px">데이터 새로고침</button>
        <button class="btn btn-small" id="testEmd" style="margin-top:6px">검색 테스트</button>
      </div>
    </div>

    <div class="section">
      <h2>선택 영역 관리</h2>
      <div class="two" style="margin-bottom:8px">
        <button class="btn" id="clearSelection">모든 선택 해제</button>
        <button class="btn ghost" id="exportSelection">선택 이름(JSON)</button>
      </div>
      <button class="btn" id="exportSelectionSvg">선택 영역 SVG 저장</button>
    </div>

    <div class="section">
      <h2>런타임 스타일</h2>
      <div class="row">
        <div><label>바다색</label><input type="color" id="waterColor" value="#0f3564"></div>
        <div><label class="muted">불투명도</label><input type="range" id="waterOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div class="row">
        <div><label>육지색</label><input type="color" id="landColor" value="#f5f5f5"></div>
        <div><label class="muted">불투명도</label><input type="range" id="landOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div><label>국가 경계선색</label><input type="color" id="countryBoundaryColor" value="#000000"></div>
      <div class="row"><label>국가 경계선 굵기(px)</label><input type="range" id="countryWidth" min="0.5" max="6" step="0.1" value="2.0"></div>
      <div class="switch"><span>국가 경계선 점선</span><input type="checkbox" id="countryDashed"></div>
      <div class="switch"><span>강/호수(내륙 수체) 표시</span><input type="checkbox" id="showRivers"></div>
      <div class="muted" style="margin-top:6px">* 바다/대양은 항상 표시됩니다 (내륙 수체만 토글).</div>
    </div>

    <div class="section">
      <h2>시도 경계선 스타일</h2>
      <div><label>시도 경계선색</label><input type="color" id="sidoBoundaryColor" value="#333333"></div>
      <div class="row"><label>시도 경계선 굵기(px)</label><input type="range" id="sidoWidth" min="0.5" max="6" step="0.1" value="1.5"></div>
      <div class="switch"><span>시도 경계선 점선</span><input type="checkbox" id="sidoDashed"></div>
    </div>

    <div class="section">
      <h2>시군구 경계선 스타일</h2>
      <div><label>시군구 경계선색</label><input type="color" id="sigunguBoundaryColor" value="#666666"></div>
      <div class="row"><label>시군구 경계선 굵기(px)</label><input type="range" id="sigunguWidth" min="0.5" max="6" step="0.1" value="1.0"></div>
      <div class="switch"><span>시군구 경계선 점선</span><input type="checkbox" id="sigunguDashed"></div>
    </div>

    <div class="section">
      <h2>읍면동 경계선 스타일</h2>
      <div><label>읍면동 경계선색</label><input type="color" id="emdBoundaryColor" value="#999999"></div>
      <div class="row"><label>읍면동 경계선 굵기(px)</label><input type="range" id="emdWidth" min="0.5" max="6" step="0.1" value="0.8"></div>
      <div class="switch"><span>읍면동 경계선 점선</span><input type="checkbox" id="emdDashed"></div>
    </div>

    <div class="section">
      <h2>경로 그리기</h2>
      <div class="two">
        <button class="btn" id="startRoute">경로 그리기 시작</button>
        <button class="btn" id="stopRoute">그리기 중지</button>
      </div>
      <div class="two" style="margin-top:6px">
        <button class="btn ghost" id="clearRoute">경로 지우기</button>
        <button class="btn ghost" id="exportRouteSvg">경로 SVG 저장</button>
      </div>
      <div class="route-info" id="routeInfo">경로 점 개수: 0</div>
    </div>

    <div class="section">
      <h2>디버깅 도구</h2>
      <div class="two" style="margin-bottom:8px">
        <button class="btn btn-small" id="forceStyle">스타일 강제 적용</button>
        <button class="btn btn-small" id="forceSelection">선택 강제 표시</button>
      </div>
      <button class="btn btn-small" id="checkLayers">레이어 상태 확인</button>
    </div>

    <div class="section">
      <h2>내보내기</h2>
      <button class="btn" id="savePng">현재 화면 PNG 저장</button>
    </div>
  </aside>

  <main id="map">
    <div id="geocoderMount" class="floating"></div>
    <div id="mapContainer"></div>
    <div id="toast" class="toast"></div>
  </main>
</div>

<script>
(function(){
  /* ==== CONFIG ==== */
  const MAPBOX_TOKEN = 'pk.eyJ1IjoibW1qanBwIiwiYSI6ImNtZmZnM3RwODBoYnEya3B6bnB3NW5zcHQifQ.6UON_8x8X84bxsCrURuggA';

  const TILESETS = {
    sido:    'mapbox://mmjjpp.25rm7fx4',
    sigungu: 'mapbox://mmjjpp.b4x5ixng',
    emd:     'mapbox://mmjjpp.53755csu',
  };
  const SOURCE_LAYERS = {
    sido:    'BND_SIDO_PG-b2cuck',
    sigungu: 'BND_SIGUNGU_PG-8djgqa',
    emd:     'BND_ADM_DONG_PG-3p138h',
  };
  const FIELDS = { sido:'SIDO_NM', sigungu:'SIGUNGU_NM', emd:'ADM_NM' };

  /* ==== DOM ==== */
  const els = {
    status: document.getElementById('status'),
    toast: document.getElementById('toast'),
    geocoderMount: document.getElementById('geocoderMount'),
    chkSido: document.getElementById('chkSido'),
    chkSigungu: document.getElementById('chkSigungu'),
    chkEmd: document.getElementById('chkEmd'),
    waterColor: document.getElementById('waterColor'),
    waterOpacity: document.getElementById('waterOpacity'),
    landColor: document.getElementById('landColor'),
    landOpacity: document.getElementById('landOpacity'),
    countryBoundaryColor: document.getElementById('countryBoundaryColor'),
    countryWidth: document.getElementById('countryWidth'),
    countryDashed: document.getElementById('countryDashed'),
    showRivers: document.getElementById('showRivers'),
    // per-level boundary controls
    sidoBoundaryColor: document.getElementById('sidoBoundaryColor'),
    sidoWidth: document.getElementById('sidoWidth'),
    sidoDashed: document.getElementById('sidoDashed'),
    sigunguBoundaryColor: document.getElementById('sigunguBoundaryColor'),
    sigunguWidth: document.getElementById('sigunguWidth'),
    sigunguDashed: document.getElementById('sigunguDashed'),
    emdBoundaryColor: document.getElementById('emdBoundaryColor'),
    emdWidth: document.getElementById('emdWidth'),
    emdDashed: document.getElementById('emdDashed'),
    clearSelection: document.getElementById('clearSelection'),
    exportSelection: document.getElementById('exportSelection'),
    exportSelectionSvg: document.getElementById('exportSelectionSvg'),
    savePng: document.getElementById('savePng'),
    // selectors
    sigunguSearch: document.getElementById('sigunguSearch'),
    sigunguDropdown: document.getElementById('sigunguDropdown'),

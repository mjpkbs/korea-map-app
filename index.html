<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Administrative Districts Map</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        select, input[type="text"], input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input[type="color"] {
            height: 40px;
            padding: 2px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: auto;
        }
        
        .selected-districts {
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .district-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .district-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        
        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .remove-btn:hover {
            background: #cc0000;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        button:hover {
            background: #005c87;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="controls">
        <div class="control-group">
            <label for="style-select">지도 스타일</label>
            <select id="style-select">
                <option value="mapbox://styles/mmjjpp/cmfto0pnq00hv01r814rrhzgc">단색</option>
                <option value="mapbox://styles/mmjjpp/cmfuo9ni000j701rf3ha412sg">Satellite</option>
                <option value="mapbox://styles/mmjjpp/cmfuohp8700go01sj1hv65fa0">Road</option>
                <option value="mapbox://styles/mmjjpp/cmfuoqlot00ix01r80bzu6p8t">Road_Bright</option>
            </select>
        </div>
        
        <div class="control-group">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="korea-boundary" checked>
                <label for="korea-boundary">한국 경계 표시</label>
            </div>
        </div>
        
        <div class="control-group">
            <label for="district-color">선택 구역 색상</label>
            <input type="color" id="district-color" value="#ff0000">
        </div>
        
        <div class="control-group">
            <label for="sigungu-search">시군구 검색</label>
            <input type="text" id="sigungu-search" list="sigungu-list" placeholder="시군구를 입력하세요">
            <datalist id="sigungu-list"></datalist>
            <button onclick="addDistrict('sigungu')">시군구 추가</button>
        </div>
        
        <div class="control-group">
            <label for="dong-search">읍면동 검색</label>
            <input type="text" id="dong-search" list="dong-list" placeholder="읍면동을 입력하세요">
            <datalist id="dong-list"></datalist>
            <button onclick="addDistrict('dong')">읍면동 추가</button>
        </div>
        
        <div class="control-group">
            <label>선택된 구역</label>
            <div class="selected-districts" id="selected-districts">
                선택된 구역이 없습니다.
            </div>
            <button onclick="clearAllDistricts()">전체 제거</button>
        </div>
    </div>

    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoibW1qanBwIiwiYSI6ImNtZmZnM3RwODBoYnEya3B6bnB3NW5zcHQifQ.6UON_8x8X84bxsCrURuggA';
        
        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mmjjpp/cmfto0pnq00hv01r814rrhzgc', // Default 단색 style
            center: [127.7669, 35.9078], // South Korea center
            zoom: 6.5
        });
        
        // Track selected districts
        let selectedDistricts = [];
        let distinctNames = {
            sigungu: new Set(),
            dong: new Set()
        };
        
        map.on('load', function() {
            // Add Korea boundary source and layer
            map.addSource('korea-boundary', {
                'type': 'vector',
                'url': 'mapbox://mapbox.country-boundaries-v1'
            });
            
            map.addLayer({
                'id': 'korea-boundary-layer',
                'type': 'line',
                'source': 'korea-boundary',
                'source-layer': 'country_boundaries',
                'filter': ['==', 'iso_3166_1', 'KR'],
                'paint': {
                    'line-color': '#000000',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });
            
            // Add administrative district sources
            map.addSource('sigungu-source', {
                'type': 'vector',
                'url': 'mapbox://mmjjpp.b4x5ixng'
            });
            
            map.addSource('dong-source', {
                'type': 'vector',
                'url': 'mapbox://mmjjpp.53755csu'
            });
            
            // Load district names for datalists
            loadDistrictNames();
        });
        
        // Style selector
        document.getElementById('style-select').addEventListener('change', function(e) {
            map.setStyle(e.target.value);
            
            // Re-add sources and layers after style change
            map.once('styledata', function() {
                // Re-add Korea boundary
                if (document.getElementById('korea-boundary').checked) {
                    addKoreaBoundary();
                }
                
                // Re-add district sources
                addDistrictSources();
                
                // Re-apply selected districts
                reapplySelectedDistricts();
            });
        });
        
        // Korea boundary toggle
        document.getElementById('korea-boundary').addEventListener('change', function(e) {
            if (e.target.checked) {
                addKoreaBoundary();
            } else {
                if (map.getLayer('korea-boundary-layer')) {
                    map.removeLayer('korea-boundary-layer');
                }
                if (map.getSource('korea-boundary')) {
                    map.removeSource('korea-boundary');
                }
            }
        });
        
        function addKoreaBoundary() {
            if (!map.getSource('korea-boundary')) {
                map.addSource('korea-boundary', {
                    'type': 'vector',
                    'url': 'mapbox://mapbox.country-boundaries-v1'
                });
            }
            
            if (!map.getLayer('korea-boundary-layer')) {
                map.addLayer({
                    'id': 'korea-boundary-layer',
                    'type': 'line',
                    'source': 'korea-boundary',
                    'source-layer': 'country_boundaries',
                    'filter': ['==', 'iso_3166_1', 'KR'],
                    'paint': {
                        'line-color': '#000000',
                        'line-width': 2,
                        'line-opacity': 0.8
                    }
                });
            }
        }
        
        function addDistrictSources() {
            if (!map.getSource('sigungu-source')) {
                map.addSource('sigungu-source', {
                    'type': 'vector',
                    'url': 'mapbox://mmjjpp.b4x5ixng'
                });
            }
            
            if (!map.getSource('dong-source')) {
                map.addSource('dong-source', {
                    'type': 'vector',
                    'url': 'mapbox://mmjjpp.53755csu'
                });
            }
        }
        
        function loadDistrictNames() {
            // This would typically be loaded from the tileset data
            // For now, we'll populate with some example names
            // In a real implementation, you'd query the tileset features
            
            // Example data - replace with actual data loading
            const sigunguExamples = [
                '서울특별시 강남구', '서울특별시 강동구', '서울특별시 강북구', '서울특별시 강서구',
                '부산광역시 해운대구', '부산광역시 부산진구', '부산광역시 동래구',
                '인천광역시 연수구', '인천광역시 남동구', '대구광역시 중구'
            ];
            
            const dongExamples = [
                '역삼동', '삼성동', '논현동', '압구정동', '청담동',
                '해운대동', '우동', '중동', '좌동', '송정동'
            ];
            
            populateDatalist('sigungu-list', sigunguExamples);
            populateDatalist('dong-list', dongExamples);
        }
        
        function populateDatalist(listId, items) {
            const datalist = document.getElementById(listId);
            datalist.innerHTML = '';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalist.appendChild(option);
            });
        }
        
        function addDistrict(type) {
            const inputId = type === 'sigungu' ? 'sigungu-search' : 'dong-search';
            const input = document.getElementById(inputId);
            const districtName = input.value.trim();
            const color = document.getElementById('district-color').value;
            
            if (!districtName) {
                alert('구역 이름을 입력해주세요.');
                return;
            }
            
            // Check if already selected
            if (selectedDistricts.some(d => d.name === districtName && d.type === type)) {
                alert('이미 선택된 구역입니다.');
                return;
            }
            
            const district = {
                name: districtName,
                type: type,
                color: color,
                id: `${type}-${Date.now()}-${Math.random()}`
            };
            
            selectedDistricts.push(district);
            addDistrictLayer(district);
            updateSelectedDistrictsDisplay();
            
            // Clear input
            input.value = '';
        }
        
        function addDistrictLayer(district) {
            const sourceId = district.type === 'sigungu' ? 'sigungu-source' : 'dong-source';
            const sourceLayer = district.type === 'sigungu' ? 'BND_SIGUNGU_PG-8djgqa' : 'BND_ADM_DONG_PG-3p138h';
            const fieldName = district.type === 'sigungu' ? 'SIGUNGU_NM' : 'ADM_NM';
            
            const layerId = district.id;
            
            map.addLayer({
                'id': layerId,
                'type': 'fill',
                'source': sourceId,
                'source-layer': sourceLayer,
                'filter': ['==', fieldName, district.name],
                'paint': {
                    'fill-color': district.color,
                    'fill-opacity': 0.6,
                    'fill-outline-color': district.color
                }
            });
        }
        
        function removeDistrict(districtId) {
            // Remove from array
            selectedDistricts = selectedDistricts.filter(d => d.id !== districtId);
            
            // Remove layer from map
            if (map.getLayer(districtId)) {
                map.removeLayer(districtId);
            }
            
            updateSelectedDistrictsDisplay();
        }
        
        function clearAllDistricts() {
            selectedDistricts.forEach(district => {
                if (map.getLayer(district.id)) {
                    map.removeLayer(district.id);
                }
            });
            
            selectedDistricts = [];
            updateSelectedDistrictsDisplay();
        }
        
        function updateSelectedDistrictsDisplay() {
            const container = document.getElementById('selected-districts');
            
            if (selectedDistricts.length === 0) {
                container.innerHTML = '선택된 구역이 없습니다.';
                return;
            }
            
            container.innerHTML = selectedDistricts.map(district => `
                <div class="district-item">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="district-color" style="background-color: ${district.color};"></div>
                        <span>${district.name}</span>
                    </div>
                    <button class="remove-btn" onclick="removeDistrict('${district.id}')">제거</button>
                </div>
            `).join('');
        }
        
        function reapplySelectedDistricts() {
            // Re-add district sources
            addDistrictSources();
            
            // Wait for sources to load, then re-add district layers
            setTimeout(() => {
                selectedDistricts.forEach(district => {
                    addDistrictLayer(district);
                });
            }, 1000);
        }
    </script>
</body>
</html>
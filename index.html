<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국지도 앱</title>
    
    <!-- Mapbox GL JS CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        .route-marker {
            width: 10px;
            height: 10px;
            background-color: #ff0000;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .color-input {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .color-input::-webkit-color-swatch {
            border: 1px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <div class="fixed top-0 left-0 right-0 z-50 bg-white shadow-md">
        <div class="flex items-center justify-between p-4">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="map" class="text-blue-600"></i>
                한국지도 앱
            </h1>
            
            <!-- Search Box -->
            <div class="flex items-center gap-2 flex-1 max-w-md mx-4">
                <div class="relative flex-1">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="주소나 장소명을 검색하세요..."
                        class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <i data-lucide="search" id="searchBtn" class="absolute right-3 top-2.5 text-gray-400 cursor-pointer hover:text-blue-500 w-5 h-5"></i>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex items-center gap-2">
                <button id="layersBtn" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="레이어 설정">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </button>
                <button id="stylesBtn" class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" title="스타일 설정">
                    <i data-lucide="palette" class="w-5 h-5"></i>
                </button>
                <button id="downloadBtn" class="p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors" title="PNG 저장">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
                <button id="routeBtn" class="p-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors" title="경로 그리기">
                    <i data-lucide="route" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Layers Panel -->
    <div id="layersPanel" class="fixed top-20 right-4 z-40 bg-white rounded-lg shadow-lg p-4 w-80 hidden control-panel">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i data-lucide="layers" class="w-5 h-5"></i>
            레이어 설정
        </h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">행정구역 레벨</label>
                <select id="adminLevel" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="sido">시도</option>
                    <option value="sigungu">시군구</option>
                    <option value="emd">읍면동</option>
                </select>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="showLabels" checked class="w-4 h-4 text-blue-600">
                <label for="showLabels" class="text-sm">라벨 표시</label>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">
                    행정구역 경계선 굵기: <span id="adminBorderWidthValue">1</span>px
                </label>
                <input type="range" id="adminBorderWidth" min="0.5" max="5" step="0.5" value="1" class="w-full">
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="adminDashed" class="w-4 h-4 text-blue-600">
                <label for="adminDashed" class="text-sm">행정구역 경계선 점선</label>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">선택 영역 색상</label>
                <input type="color" id="highlightColor" value="#ff6b6b" class="color-input">
            </div>

            <div id="selectedAreasInfo" class="hidden">
                <label class="block text-sm font-medium mb-2">선택된 지역</label>
                <div id="selectedAreasList" class="bg-gray-50 p-2 rounded text-xs max-h-20 overflow-y-auto"></div>
                <button id="clearSelection" class="mt-2 px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                    선택 해제
                </button>
            </div>
        </div>
    </div>

    <!-- Styles Panel -->
    <div id="stylesPanel" class="fixed top-20 right-4 z-40 bg-white rounded-lg shadow-lg p-4 w-80 hidden control-panel">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i data-lucide="settings" class="w-5 h-5"></i>
            스타일 설정
        </h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">맵 스타일</label>
                <select id="mapStyle" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="mapbox://styles/mapbox/light-v11">라이트</option>
                    <option value="mapbox://styles/mapbox/dark-v11">다크</option>
                    <option value="mapbox://styles/mapbox/satellite-v9">위성</option>
                    <option value="mapbox://styles/mapbox/streets-v12">거리</option>
                    <option value="mapbox://styles/mapbox/outdoors-v12">야외</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">바다색</label>
                <input type="color" id="seaColor" value="#0f3564" class="color-input">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">육지색</label>
                <input type="color" id="landColor" value="#8896a1" class="color-input">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">경계선색</label>
                <input type="color" id="borderColor" value="#ffffff" class="color-input">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">
                    국가 경계선 굵기: <span id="borderWidthValue">1</span>px
                </label>
                <input type="range" id="borderWidth" min="0.5" max="5" step="0.5" value="1" class="w-full">
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="dashedBorder" class="w-4 h-4 text-blue-600">
                <label for="dashedBorder" class="text-sm">국가 경계선 점선</label>
            </div>
        </div>
    </div>

    <!-- Route Drawing Info -->
    <div id="routeInfo" class="fixed top-20 left-4 z-40 bg-yellow-100 border border-yellow-400 rounded-lg p-4 max-w-sm hidden">
        <h4 class="font-semibold text-yellow-800">경로 그리기 모드</h4>
        <p class="text-sm text-yellow-700 mt-1">
            지도를 클릭하여 경로를 그려보세요. 현재 점: <span id="routePointCount">0</span>개
        </p>
        <div class="flex gap-2 mt-2">
            <button id="saveSvgBtn" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                SVG 저장
            </button>
            <button id="clearRouteBtn" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                초기화
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map" class="w-full h-screen" style="padding-top: 80px;"></div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
            <p class="text-lg">지도를 로딩중입니다...</p>
            <p class="text-xs text-red-500 mt-2">
                ⚠️ Mapbox 토큰을 설정해주세요 (69번째 줄)
            </p>
        </div>
    </div>

    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.min.js"></script>
    
    <script>
        // ⚠️ 여기에 실제 Mapbox 토큰을 입력하세요!
        mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
        
        // 전역 변수들
        let map;
        let isDrawingRoute = false;
        let routePoints = [];
        let selectedAreas = [];
        let currentAdminLevel = 'sido';
        let geoJsonData = {};
        let routeMarkers = [];

        // Lucide 아이콘 초기화
        lucide.createIcons();

        // 맵 초기화
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [127.7669, 35.9078], // 한국 중심 좌표
                zoom: 6.5,
                preserveDrawingBuffer: true
            });

            map.on('load', async () => {
                document.getElementById('loadingScreen').style.display = 'none';
                
                // Navigation controls 추가
                map.addControl(new mapboxgl.NavigationControl());
                
                // GeoJSON 데이터 로드
                await loadGeoJsonData();
                
                // 기본 스타일 적용
                updateMapStyles();
                
                // 이벤트 리스너 설정
                setupEventListeners();
                
                console.log('지도 로딩 완료!');
            });

            map.on('error', (e) => {
                console.error('Mapbox 에러:', e);
                document.querySelector('#loadingScreen p').innerHTML = 
                    '지도 로딩 실패! Mapbox 토큰을 확인해주세요.';
            });
        }

        // GeoJSON 데이터 로드
        async function loadGeoJsonData() {
            try {
                // 시도 데이터 로드
                const sidoResponse = await fetch('./data/sido.geojson');
                if (sidoResponse.ok) {
                    geoJsonData.sido = await sidoResponse.json();
                    console.log('시도 데이터 로드 완료');
                } else {
                    console.warn('시도 데이터 로드 실패 - 샘플 데이터 사용');
                    geoJsonData.sido = createSampleSidoData();
                }
                
                // 시군구 데이터 로드 (옵션)
                try {
                    const sigunguResponse = await fetch('./data/sigungu.geojson');
                    if (sigunguResponse.ok) {
                        geoJsonData.sigungu = await sigunguResponse.json();
                        console.log('시군구 데이터 로드 완료');
                    }
                } catch (e) {
                    console.warn('시군구 데이터 없음');
                }
                
                // 읍면동 데이터 로드 (옵션)
                try {
                    const emdResponse = await fetch('./data/emd.geojson');
                    if (emdResponse.ok) {
                        geoJsonData.emd = await emdResponse.json();
                        console.log('읍면동 데이터 로드 완료');
                    }
                } catch (e) {
                    console.warn('읍면동 데이터 없음');
                }
                
                // 현재 레벨 데이터 표시
                displayAdminLevel(currentAdminLevel);
                
            } catch (error) {
                console.error('GeoJSON 로드 에러:', error);
                // 샘플 데이터 사용
                geoJsonData.sido = createSampleSidoData();
                displayAdminLevel('sido');
            }
        }

        // 샘플 시도 데이터 생성
        function createSampleSidoData() {
            return {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: { SIDO_NM: '서울특별시', id: 'seoul' },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[[126.734, 37.413], [127.269, 37.413], [127.269, 37.715], [126.734, 37.715], [126.734, 37.413]]]
                        }
                    },
                    {
                        type: 'Feature',
                        properties: { SIDO_NM: '경기도', id: 'gyeonggi' },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[[126.5, 37.2], [127.8, 37.2], [127.8, 37.9], [126.5, 37.9], [126.5, 37.2]]]
                        }
                    },
                    {
                        type: 'Feature',
                        properties: { SIDO_NM: '강원도', id: 'gangwon' },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[[127.8, 37.2], [129.0, 37.2], [129.0, 38.5], [127.8, 38.5], [127.8, 37.2]]]
                        }
                    }
                ]
            };
        }

        // 행정구역 레벨 표시
        function displayAdminLevel(level) {
            if (!geoJsonData[level]) {
                console.warn(`${level} 데이터가 없습니다.`);
                return;
            }

            // 기존 레이어 제거
            removeAdminLayers();

            const data = geoJsonData[level];
            const nameField = getNameField(level);

            // 소스 추가
            map.addSource('admin-boundaries', {
                type: 'geojson',
                data: data
            });

            // Fill 레이어 (투명한 클릭 영역)
            map.addLayer({
                id: 'admin-fill',
                type: 'fill',
                source: 'admin-boundaries',
                paint: {
                    'fill-color': 'transparent',
                    'fill-opacity': 0.1
                }
            });

            // Line 레이어 (경계선)
            map.addLayer({
                id: 'admin-line',
                type: 'line',
                source: 'admin-boundaries',
                paint: {
                    'line-color': document.getElementById('borderColor').value,
                    'line-width': parseFloat(document.getElementById('adminBorderWidth').value),
                    'line-dasharray': document.getElementById('adminDashed').checked ? [3, 3] : [1, 0]
                }
            });

            // Label 레이어
            map.addLayer({
                id: 'admin-labels',
                type: 'symbol',
                source: 'admin-boundaries',
                layout: {
                    'text-field': ['get', nameField],
                    'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
                    'text-size': 12,
                    'visibility': document.getElementById('showLabels').checked ? 'visible' : 'none'
                },
                paint: {
                    'text-color': '#333',
                    'text-halo-color': '#fff',
                    'text-halo-width': 1
                }
            });

            // 선택된 지역 하이라이트 레이어
            map.addLayer({
                id: 'selected-areas',
                type: 'fill',
                source: 'admin-boundaries',
                paint: {
                    'fill-color': document.getElementById('highlightColor').value,
                    'fill-opacity': 0.6
                },
                filter: ['in', 'id', ...selectedAreas]
            });

            console.log(`${level} 레이어 추가 완료`);
        }

        // 이름 필드 반환
        function getNameField(level) {
            switch (level) {
                case 'sido': return 'SIDO_NM';
                case 'sigungu': return 'SIGUNGU_NM';
                case 'emd': return 'ADM_NM';
                default: return 'name';
            }
        }

        // 기존 행정구역 레이어 제거
        function removeAdminLayers() {
            const layers = ['selected-areas', 'admin-labels', 'admin-line', 'admin-fill'];
            layers.forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }
            });
            
            if (map.getSource('admin-boundaries')) {
                map.removeSource('admin-boundaries');
            }
        }

        // 맵 스타일 업데이트
        function updateMapStyles() {
            const seaColor = document.getElementById('seaColor').value;
            const landColor = document.getElementById('landColor').value;
            const borderColor = document.getElementById('borderColor').value;
            const borderWidth = document.getElementById('borderWidth').value;
            const isDashed = document.getElementById('dashedBorder').checked;

            // 바다색 변경
            if (map.getLayer('water')) {
                map.setPaintProperty('water', 'fill-color', seaColor);
            }
            
            // 육지색 변경
            if (map.getLayer('land')) {
                map.setPaintProperty('land', 'fill-color', landColor);
            }

            // 국가 경계선 스타일
            if (map.getLayer('admin-0-boundary')) {
                map.setPaintProperty('admin-0-boundary', 'line-color', borderColor);
                map.setPaintProperty('admin-0-boundary', 'line-width', parseFloat(borderWidth));
                map.setPaintProperty('admin-0-boundary', 'line-dasharray', isDashed ? [2, 2] : [1, 0]);
            }

            // 행정구역 경계선 스타일
            if (map.getLayer('admin-line')) {
                map.setPaintProperty('admin-line', 'line-color', borderColor);
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 패널 토글
            document.getElementById('layersBtn').onclick = () => togglePanel('layersPanel');
            document.getElementById('stylesBtn').onclick = () => togglePanel('stylesPanel');

            // 스타일 변경 이벤트
            ['seaColor', 'landColor', 'borderColor'].forEach(id => {
                document.getElementById(id).onchange = updateMapStyles;
            });

            document.getElementById('borderWidth').oninput = (e) => {
                document.getElementById('borderWidthValue').textContent = e.target.value;
                updateMapStyles();
            };

            document.getElementById('dashedBorder').onchange = updateMapStyles;

            // 행정구역 관련 이벤트
            document.getElementById('adminLevel').onchange = (e) => {
                currentAdminLevel = e.target.value;
                selectedAreas = [];
                updateSelectedAreasDisplay();
                displayAdminLevel(currentAdminLevel);
            };

            document.getElementById('adminBorderWidth').oninput = (e) => {
                document.getElementById('adminBorderWidthValue').textContent = e.target.value;
                if (map.getLayer('admin-line')) {
                    map.setPaintProperty('admin-line', 'line-width', parseFloat(e.target.value));
                }
            };

            document.getElementById('adminDashed').onchange = (e) => {
                if (map.getLayer('admin-line')) {
                    map.setPaintProperty('admin-line', 'line-dasharray', e.target.checked ? [3, 3] : [1, 0]);
                }
            };

            document.getElementById('showLabels').onchange = (e) => {
                if (map.getLayer('admin-labels')) {
                    map.setLayoutProperty('admin-labels', 'visibility', e.target.checked ? 'visible' : 'none');
                }
            };

            document.getElementById('highlightColor').onchange = (e) => {
                if (map.getLayer('selected-areas')) {
                    map.setPaintProperty('selected-areas', 'fill-color', e.target.value);
                }
            };

            document.getElementById('clearSelection').onclick = () => {
                selectedAreas = [];
                updateSelectedAreasDisplay();
                updateSelectedAreasFilter();
            };

            // 맵 스타일 변경
            document.getElementById('mapStyle').onchange = (e) => {
                map.setStyle(e.target.value);
                map.once('styledata', () => {
                    // 스타일 변경 후 레이어 다시 추가
                    setTimeout(() => {
                        displayAdminLevel(currentAdminLevel);
                        updateMapStyles();
                    }, 1000);
                });
            };

            // 다운로드
            document.getElementById('downloadBtn').onclick = saveMapAsPNG;

            // 경로 그리기
            document.getElementById('routeBtn').onclick = toggleRouteDrawing;
            document.getElementById('saveSvgBtn').onclick = saveRouteAsSVG;
            document.getElementById('clearRouteBtn').onclick = clearRoute;

            // 검색
            document.getElementById('searchBtn').onclick = handleSearch;
            document.getElementById('searchInput').onkeypress = (e) => {
                if (e.key === 'Enter') handleSearch();
            };

            // 맵 클릭 이벤트
            map.on('click', 'admin-fill', handleMapClick);
            map.on('mouseenter', 'admin-fill', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'admin-fill', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        // 패널 토글
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isHidden = panel.classList.contains('hidden');
            
            // 모든 패널 숨기기
            document.getElementById('layersPanel').classList.add('hidden');
            document.getElementById('stylesPanel').classList.add('hidden');
            
            // 선택된 패널만 표시
            if (isHidden) {
                panel.classList.remove('hidden');
            }
        }

        // 맵 클릭 처리
        function handleMapClick(e) {
            if (isDrawingRoute) {
                addRoutePoint([e.lngLat.lng, e.lngLat.lat]);
                return;
            }

            const features = map.queryRenderedFeatures(e.point, {
                layers: ['admin-fill']
            });

            if (features.length > 0) {
                const feature = features[0];
                const areaId = feature.properties.id || feature.properties.name || 
                              feature.properties.SIDO_NM || feature.properties.SIGUNGU_NM || 
                              feature.properties.ADM_NM;
                
                if (areaId) {
                    if (selectedAreas.includes(areaId)) {
                        selectedAreas = selectedAreas.filter(id => id !== areaId);
                    } else {
                        selectedAreas.push(areaId);
                    }
                    
                    updateSelectedAreasDisplay();
                    updateSelectedAreasFilter();
                }
            }
        }

        // 선택된 지역 표시 업데이트
        function updateSelectedAreasDisplay() {
            const infoDiv = document.getElementById('selectedAreasInfo');
            const listDiv = document.getElementById('selectedAreasList');
            
            if (selectedAreas.length > 0) {
                infoDiv.classList.remove('hidden');
                listDiv.textContent = selectedAreas.join(', ');
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // 선택된 지역 필터 업데이트
        function updateSelectedAreasFilter() {
            if (map.getLayer('selected-areas')) {
                map.setFilter('selected-areas', ['in', 'id', ...selectedAreas]);
            }
        }

        // 경로 그리기 토글
        function toggleRouteDrawing() {
            isDrawingRoute = !isDrawingRoute;
            const routeInfo = document.getElementById('routeInfo');
            const routeBtn = document.getElementById('routeBtn');
            
            if (isDrawingRoute) {
                routeInfo.classList.remove('hidden');
                routeBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                routeBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                map.getCanvas().style.cursor = 'crosshair';
            } else {
                routeInfo.classList.add('hidden');
                routeBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                routeBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                map.getCanvas().style.cursor = '';
            }
        }

        // 경로 점 추가
        function addRoutePoint(coordinates) {
            routePoints.push(coordinates);
            document.getElementById('routePointCount').textContent = routePoints.length;
            
            // 마커 추가
            const marker = new mapboxgl.Marker({
                color: '#ff0000'
            }).setLngLat(coordinates).addTo(map);
            
            routeMarkers.push(marker);
            
            // 경로 라인 업데이트
            updateRouteLine();
        }

        // 경로 라인 업데이트
        function updateRouteLine() {
            if (routePoints.length < 2) return;

            const routeGeoJSON = {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: routePoints
                }
            };

            if (map.getSource('route')) {
                map.getSource('route').setData(routeGeoJSON);
            } else {
                map.addSource('route', {
                    type: 'geojson',
                    data: routeGeoJSON
                });

                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    paint: {
                        'line-color': '#ff0000',
                        'line-width': 3
                    }
                });
            }
        }

        // 경로 초기화
        function clearRoute() {
            routePoints = [];
            document.getElementById('routePointCount').textContent = '0';
            
            // 마커 제거
            routeMarkers.forEach(marker => marker.remove());
            routeMarkers = [];
            
            // 라인 제거
            if (map.getLayer('route')) {
                map.removeLayer('route');
                map.removeSource('route');
            }
        }

        // PNG 저장
        function saveMapAsPNG() {
            const canvas = map.getCanvas();
            const link = document.createElement('a');
            link.download = 'korea-map.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // SVG 저장
        function saveRouteAsSVG() {
            if (routePoints.length < 2) {
                alert('경로를 그려주세요.');
                return;
            }

            const canvas = map.getCanvas();
            const mapWidth = canvas.width;
            const mapHeight = canvas.height;

            // 좌표를 화면 픽셀로 변환
            const pixelPoints = routePoints.map(point => {
                const pixel = map.project(point);
                return [pixel.x, pixel.y];
            });

            // SVG 생성
            const svgContent = `
                <svg width="${mapWidth}" height="${mapHeight}" viewBox="0 0 ${mapWidth} ${mapHeight}" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="${pixelPoints.map(p => p.join(',')).join(' ')}" 
                              stroke="red" stroke-width="3" fill="none"/>
                    ${pixelPoints.map((point, index) => 
                        `<circle cx="${point[0]}" cy="${point[1]}" r="5" fill="red" stroke="white" stroke-width="2"/>`
                    ).join('')}
                </svg>
            `;

            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const link = document.createElement('a');
            link.download = 'route.svg';
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        // 검색 처리
        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            alert(`"${query}" 검색 기능은 Geocoding API 연동이 필요합니다.`);
        }

        // 페이지 로드 시 맵 초기화
        window.onload = () => {
            initMap();
        };
    </script>
</body>
</html>
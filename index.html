<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>한국 지도 — Tilesets + 런타임 스타일 (Fixed)</title>

<!-- Mapbox (공식 CDN) -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.2/mapbox-gl-geocoder.min.js"></script>

<style>
  :root{ --bg:#0b0f14; --panel:#11161d; --muted:#9fb0c3; --border:#1f2a36; --text:#e6eef7; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
  #app{display:grid;grid-template-columns:360px 1fr;height:100%}
  #panel{background:#11161d;border-right:1px solid var(--border);padding:14px;overflow:auto}
  #map{position:relative}
  #mapContainer{width:100%;height:100%}
  h1{font-size:18px;margin:0 0 8px}
  h2{font-size:13px;margin:10px 0;color:var(--muted);font-weight:700;letter-spacing:.4px}
  label{display:block;font-size:13px;margin:8px 0 4px}
  input[type="text"]{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:10px;background:#0c1218;color:#e6eef7}
  input[type="color"]{width:100%;height:38px;border:1px solid var(--border);border-radius:10px;background:#0c1218}
  input[type="range"]{width:100%}
  .row{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{background:#13202c;border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{background:#0f1a24}
  .ghost{background:transparent}
  .section{background:#0c1218;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
  .switch{display:flex;align-items:center;justify-content:space-between}
  .muted{color:var(--muted);font-size:12px}
  .floating{position:absolute;top:10px;left:10px;z-index:5}
  .toast{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;padding:8px 10px;border-radius:8px;z-index:10;display:none}

  /* Geocoder 입력이 안 보이는 문제 해결 (다크 테마) */
  .mapboxgl-ctrl-geocoder, .mapboxgl-ctrl-geocoder .suggestions{background:#0c1218 !important; color:#e6eef7 !important;}
  .mapboxgl-ctrl-geocoder input[type='text']{color:#e6eef7 !important;}
  .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input::placeholder{color:#9fb0c3 !important;}
  .mapboxgl-ctrl-geocoder .suggestions > li{color:#e6eef7 !important; background:#0c1218 !important;}
  .mapboxgl-ctrl-geocoder .suggestions > .active{background:#13202c !important;}
</style>
</head>
<body>
<div id="app">
  <aside id="panel">
    <h1>한국 지도 앱 — Tilesets Vector</h1>
    <div class="section">
      <label>Mapbox Access Token</label>
      <input id="token" type="text" placeholder="본인 Access Token" />
      <div class="two" style="margin-top:8px">
        <button class="btn" id="initMap">지도 초기화</button>
        <button class="btn ghost" id="saveToken">토큰 저장</button>
      </div>
      <div class="muted" id="libStatus" style="margin-top:6px">Mapbox GL 로드됨</div>
    </div>

    <div class="section">
      <h2>행정구역 레벨 (타일셋)</h2>
      <div class="switch"><span>시도</span><input type="checkbox" id="chkSido"></div>
      <div class="switch"><span>시군구</span><input type="checkbox" id="chkSigungu"></div>
      <div class="switch"><span>읍면동</span><input type="checkbox" id="chkEmd"></div>
      <div class="muted" style="margin-top:6px">* 켜면 해당 타일셋 레이어 추가, 끄면 제거</div>
    </div>

    <div class="section">
      <h2>라벨</h2>
      <div class="switch"><span>Mapbox 기본 라벨</span><input type="checkbox" id="chkBaseLabels" checked></div>
      <div class="switch"><span>행정 라벨(우리 타일셋)</span><input type="checkbox" id="chkOurLabels" checked></div>
    </div>

    <div class="section">
      <h2>런타임 스타일</h2>
      <div class="row">
        <div><label>바다색</label><input type="color" id="waterColor" value="#0f3564"></div>
        <div><label class="muted">불투명도</label><input type="range" id="waterOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div class="row">
        <div><label>육지색</label><input type="color" id="landColor" value="#8896a1"></div>
        <div><label class="muted">불투명도</label><input type="range" id="landOpacity" min="0" max="1" step="0.01" value="1"></div>
      </div>
      <div><label>경계선색</label><input type="color" id="boundaryColor" value="#ffffff"></div>
      <div class="row"><label>나라 경계선 굵기(px)</label><input type="range" id="countryWidth" min="0.5" max="6" step="0.1" value="1.5"></div>
      <div class="switch"><span>나라 경계선 점선</span><input type="checkbox" id="countryDashed"></div>
      <div class="row" style="margin-top:8px"><label>행정 경계선 굵기(px)</label><input type="range" id="adminWidth" min="0.5" max="6" step="0.1" value="1.0"></div>
      <div class="switch"><span>행정 경계선 점선</span><input type="checkbox" id="adminDashed"></div>
    </div>

    <div class="section">
      <h2>선택 영역 색칠</h2>
      <label>선택 색</label><input type="color" id="selectColor" value="#ffcc33">
      <div class="switch"><span>반투명</span><input type="checkbox" id="selectHalf" checked></div>
      <div class="two" style="margin-top:8px">
        <button class="btn" id="clearSelection">선택 해제</button>
        <button class="btn ghost" id="exportSelection">선택 이름(JSON)</button>
      </div>
      <div class="muted" style="margin-top:6px">* 채움 레이어 클릭으로 다중 선택</div>
    </div>

    <div class="section">
      <h2>PNG 저장</h2>
      <button class="btn" id="savePng">현재 화면 PNG 저장</button>
    </div>

    <div class="section">
      <h2>상태</h2>
      <div id="status">준비 전…</div>
    </div>
  </aside>

  <main id="map">
    <div id="geocoderMount" class="floating"></div>
    <div id="mapContainer"></div>
    <div id="toast" class="toast"></div>
  </main>
</div>

<script>
(function(){
  /* ==== CONFIG: 타일셋 & 레이어 이름 & 라벨 필드 ==== */
  const TILESETS = {
    sido:    'mapbox://mmjjpp.25rm7fx4',
    sigungu: 'mapbox://mmjjpp.b4x5ixng',
    emd:     'mapbox://mmjjpp.53755csu',
  };
  const SOURCE_LAYERS = {
    sido:    'BND_SIDO_PG-b2cuck',
    sigungu: 'BND_SIGUNGU_PG-8djgqa',
    emd:     'BND_ADM_DONG_PG-3p138h',
  };
  const FIELDS = { sido:'SIDO_NM', sigungu:'SIGUNGU_NM', emd:'ADM_NM' };

  /* ==== DOM ==== */
  const els = {
    token: document.getElementById('token'),
    initMap: document.getElementById('initMap'),
    saveToken: document.getElementById('saveToken'),
    geocoderMount: document.getElementById('geocoderMount'),
    status: document.getElementById('status'),
    toast: document.getElementById('toast'),
    chkSido: document.getElementById('chkSido'),
    chkSigungu: document.getElementById('chkSigungu'),
    chkEmd: document.getElementById('chkEmd'),
    chkBaseLabels: document.getElementById('chkBaseLabels'),
    chkOurLabels: document.getElementById('chkOurLabels'),
    waterColor: document.getElementById('waterColor'),
    waterOpacity: document.getElementById('waterOpacity'),
    landColor: document.getElementById('landColor'),
    landOpacity: document.getElementById('landOpacity'),
    boundaryColor: document.getElementById('boundaryColor'),
    countryWidth: document.getElementById('countryWidth'),
    adminWidth: document.getElementById('adminWidth'),
    countryDashed: document.getElementById('countryDashed'),
    adminDashed: document.getElementById('adminDashed'),
    selectColor: document.getElementById('selectColor'),
    selectHalf: document.getElementById('selectHalf'),
    clearSelection: document.getElementById('clearSelection'),
    exportSelection: document.getElementById('exportSelection'),
    savePng: document.getElementById('savePng'),
  };

  /* ==== 상태 ==== */
  let map=null, detected=null;
  const selected = { sido:new Set(), sigungu:new Set(), emd:new Set() };

  /* ==== 유틸 ==== */
  const STORE='kr-map-index';
  function toast(msg){ els.toast.textContent=msg; els.toast.style.display='block'; setTimeout(()=> els.toast.style.display='none', 2000); }
  function setStatus(msg){ els.status.textContent=msg; }
  function saveLocal(){ localStorage.setItem(STORE, JSON.stringify({ token: els.token.value.trim() })); }
  function loadLocal(){ try{ const d=JSON.parse(localStorage.getItem(STORE)||'{}'); if(d.token) els.token.value=d.token; }catch{} }
  function firstSymbolId(){ const layers=map.getStyle()?.layers||[]; const sym=layers.find(l=>l.type==='symbol'); return sym?.id; }
  function tryPaint(id,prop,val){ try{ map.setPaintProperty(id,prop,val); }catch{} }
  function tryLayout(id,prop,val){ try{ map.setLayoutProperty(id,prop,val); }catch{} }

  /* ==== 초기 바인딩 ==== */
  function init(){
    loadLocal();
    els.initMap.addEventListener('click', createMap);
    els.saveToken.addEventListener('click', ()=>{ saveLocal(); toast('토큰 저장'); });

    els.chkSido.addEventListener('change', ()=> toggleLevel('sido', els.chkSido.checked));
    els.chkSigungu.addEventListener('change', ()=> toggleLevel('sigungu', els.chkSigungu.checked));
    els.chkEmd.addEventListener('change', ()=> toggleLevel('emd', els.chkEmd.checked));

    els.chkBaseLabels.addEventListener('change', ()=> toggleBaseLabels(els.chkBaseLabels.checked));
    els.chkOurLabels.addEventListener('change', applyOurLabelsVisibility);

    [els.waterColor, els.waterOpacity, els.landColor, els.landOpacity, els.boundaryColor,
     els.countryWidth, els.adminWidth, els.countryDashed, els.adminDashed]
     .forEach(el => el.addEventListener('input', applyRuntimeColors));

    els.selectColor.addEventListener('input', updateSelectionStyles);
    els.selectHalf.addEventListener('change', updateSelectionStyles);
    els.clearSelection.addEventListener('click', ()=>{
      ['sido','sigungu','emd'].forEach(k=>selected[k].clear());
      updateSelectionFilters();
      setStatus('선택 해제됨');
    });
    els.exportSelection.addEventListener('click', ()=>{
      const out = { sido:[...selected.sido], sigungu:[...selected.sigungu], emd:[...selected.emd] };
      const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='selection-names.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    });

    els.savePng.addEventListener('click', savePNG);
  }

  /* ==== 지도 생성 ==== */
  function createMap(){
    const token = els.token.value.trim();
    if(!token){ toast('Access Token을 입력하세요.'); return; }
    saveLocal();

    mapboxgl.accessToken = token;
    if(map){ map.remove(); map=null; }

    map = new mapboxgl.Map({
      container: 'mapContainer',
      style: 'mapbox://styles/mapbox/light-v11',  /* ← 표준 스타일 대신 light-v11로 */
      center: [127.8, 36.3],
      zoom: 6,
      locale: 'ko',
      preserveDrawingBuffer: true
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, language:'ko,en', placeholder:'주소 또는 키워드 검색…' });
    els.geocoderMount.innerHTML='';
    els.geocoderMount.appendChild(geocoder.onAdd(map));
    geocoder.on('result', e=>{
      if(e.result?.bbox){ const b=e.result.bbox; map.fitBounds([[b[0],b[1]],[b[2],b[3]]], { padding:60, duration:900 }); }
      else if(e.result?.center){ map.flyTo({ center:e.result.center, zoom:14 }); }
    });

    map.on('load', ()=>{
      detected = detectLayers();       // 기본 레이어 캐시
      applyRuntimeColors();            // 바다/육지/경계 색 적용
      toggleBaseLabels(els.chkBaseLabels.checked); // 기본 라벨 가시성
      setStatus('지도 로드됨 — 타일셋 레벨을 켜세요.');
    });

    map.on('style.load', ()=>{         // 스타일 재로딩 시 재적용
      detected = detectLayers();
      applyRuntimeColors();
      toggleBaseLabels(els.chkBaseLabels.checked);
      applyOurLabelsVisibility();

      if(els.chkSido.checked) addLevel('sido');
      if(els.chkSigungu.checked) addLevel('sigungu');
      if(els.chkEmd.checked) addLevel('emd');

      updateSelectionStyles();
      updateSelectionFilters();
    });
  }

  /* ==== 기본 스타일 레이어 탐지 (light-v11 기준) ==== */
  function detectLayers(){
    const L = map.getStyle()?.layers || [];
    const found = { water:[], landBg:[], landFill:[], boundary:[], baseLabelIds:[] };

    // 우선순위 후보: light-v11에서 자주 쓰이는 이름들
    const waterIds = ['water','water-outline','water-shadow'];
    const landBgIds = ['background','land'];        // background 타입
    const landFillCandidates = ['land','landcover','landuse','natural']; // id 일부/소스레이어 일부에 포함
    const boundaryRegex = /(admin|boundary|country)/i;

    for(const l of L){
      const id = l.id || '';
      const type = l.type;
      const srcLayer = (l['source-layer']||'');

      // 물
      if (waterIds.includes(id) || /water|ocean|sea/i.test(id+' '+srcLayer)){
        if (['fill','line','background'].includes(type)) found.water.push(id);
      }

      // 육지
      if (type==='background' && landBgIds.includes(id)) found.landBg.push(id);
      if (type==='fill' && landFillCandidates.some(k=> new RegExp(k,'i').test(id+' '+srcLayer))){
        found.landFill.push(id);
      }

      // 경계(국경/행정)
      if (type==='line' && boundaryRegex.test(id+' '+srcLayer)) found.boundary.push(id);

      // 기본 라벨 = symbol 전부(우리 레이어는 id로 구분)
      if (type==='symbol' && !/(^|-)sido-label|sigungu-label|emd-label/.test(id)) {
        // road-label, place-label, poi-label 등 모두 포함
        found.baseLabelIds.push(id);
      }
    }
    return found;
  }

  /* ==== 레벨 토글 ==== */
  async function toggleLevel(lvl, on){
    if(on) await addLevel(lvl); else removeLevel(lvl);
    applyOurLabelsVisibility();
    applyRuntimeColors();
    updateSelectionStyles();
    updateSelectionFilters();
  }

  async function addLevel(lvl){
    const srcId = `${lvl}-src`;
    if(!map.getSource(srcId)){
      map.addSource(srcId, { type:'vector', url: TILESETS[lvl] });
    }

    const fillId = `${lvl}-fill`;
    if(!map.getLayer(fillId)){
      map.addLayer({
        id: fillId, type:'fill', source: srcId, 'source-layer': SOURCE_LAYERS[lvl],
        paint:{ 'fill-color':'#ffffff', 'fill-opacity':0.03 },
        minzoom: (lvl==='emd'? 9 : lvl==='sigungu'? 6 : 0)
      }, firstSymbolId());
      bindSelect(fillId, lvl);
    }

    const lineId = `${lvl}-line`;
    if(!map.getLayer(lineId)){
      map.addLayer({
        id: lineId, type:'line', source: srcId, 'source-layer': SOURCE_LAYERS[lvl],
        paint:{
          'line-color': els.boundaryColor.value,
          'line-width': parseFloat(els.adminWidth.value),
          'line-dasharray': els.adminDashed.checked ? [2,2] : [1,0]
        },
        minzoom: (lvl==='emd'? 9 : lvl==='sigungu'? 6 : 0)
      });
    }

    const labelId = `${lvl}-label`;
    if(!map.getLayer(labelId)){
      map.addLayer({
        id: labelId, type:'symbol', source: srcId, 'source-layer': SOURCE_LAYERS[lvl],
        layout:{
          'text-field': ['get', FIELDS[lvl]],
          'text-size': ['interpolate',['linear'],['zoom'],6,10,10,12,14,16],
          'text-allow-overlap': false
        },
        paint:{
          'text-color':'#1f2940','text-halo-color':'#fff','text-halo-width':1.2,'text-opacity': 1
        },
        minzoom: (lvl==='emd'? 10 : lvl==='sigungu'? 7 : 4)
      });
    }

    const selId = `${lvl}-selection`;
    if(!map.getLayer(selId)){
      map.addLayer({
        id: selId, type:'fill', source: srcId, 'source-layer': SOURCE_LAYERS[lvl],
        paint:{
          'fill-color': els.selectColor.value,
          'fill-opacity': els.selectHalf.checked ? 0.5 : 1.0
        },
        filter: ['in', ['get', FIELDS[lvl]], ['literal', []]],
        minzoom: (lvl==='emd'? 9 : lvl==='sigungu'? 6 : 0)
      }, firstSymbolId());
    }

    setStatus(`로드됨: ${lvl}`);
  }

  function removeLevel(lvl){
    ['selection','label','line','fill'].forEach(sfx=>{
      const id = `${lvl}-${sfx}`;
      if(map.getLayer(id)) map.removeLayer(id);
    });
    const srcId = `${lvl}-src`;
    if(map.getSource(srcId)) map.removeSource(srcId);

    selected[lvl].clear();
  }

  /* ==== 클릭 선택 ==== */
  function bindSelect(fillLayerId, lvl){
    if(!map.getLayer(fillLayerId)) return;
    map._bindSel = map._bindSel || {};
    if(map._bindSel[fillLayerId]) return;

    map.on('click', fillLayerId, (e)=>{
      const feats = map.queryRenderedFeatures(e.point, { layers:[fillLayerId] });
      if(!feats.length) return;
      const name = feats[0].properties?.[FIELDS[lvl]];
      if(!name) return;
      if(selected[lvl].has(name)) selected[lvl].delete(name); else selected[lvl].add(name);
      updateSelectionFilters();
      setStatus(`선택: 시도 ${selected.sido.size} · 시군구 ${selected.sigungu.size} · 읍면동 ${selected.emd.size}`);
    });
    map.on('mouseenter', fillLayerId, ()=> map.getCanvas().style.cursor='pointer');
    map.on('mouseleave', fillLayerId, ()=> map.getCanvas().style.cursor='');
    map._bindSel[fillLayerId] = true;
  }

  function updateSelectionStyles(){
    ['sido','sigungu','emd'].forEach(lvl=>{
      const id = `${lvl}-selection`;
      if(map && map.getLayer(id)){
        map.setPaintProperty(id,'fill-color', els.selectColor.value);
        map.setPaintProperty(id,'fill-opacity', els.selectHalf.checked ? 0.5 : 1.0);
      }
    });
  }

  function updateSelectionFilters(){
    ['sido','sigungu','emd'].forEach(lvl=>{
      const id = `${lvl}-selection`;
      if(map && map.getLayer(id)){
        map.setFilter(id, ['in', ['get', FIELDS[lvl]], ['literal', Array.from(selected[lvl])]]);
      }
    });
  }

  /* ==== 기본 라벨 ON/OFF ==== */
  function toggleBaseLabels(show){
    if(!map) return;
    // light-v11 기준: 모든 symbol 레이어(우리 라벨 제외) 가시성 토글
    const L = map.getStyle()?.layers || [];
    for(const l of L){
      if(l.type==='symbol' && !/(^|-)sido-label|sigungu-label|emd-label/.test(l.id)){
        tryLayout(l.id, 'visibility', show ? 'visible' : 'none');
      }
    }
  }

  /* ==== 우리 라벨 ON/OFF ==== */
  function applyOurLabelsVisibility(){
    const v = els.chkOurLabels.checked ? 'visible' : 'none';
    ['sido-label','sigungu-label','emd-label'].forEach(id=>{
      if(map && map.getLayer(id)) tryLayout(id, 'visibility', v);
    });
  }

  /* ==== 런타임 스타일 (물/육지/경계) ==== */
  function applyRuntimeColors(){
    if(!map) return;
    const sea=els.waterColor.value, land=els.landColor.value, bcol=els.boundaryColor.value;
    const wOp=parseFloat(els.waterOpacity.value), lOp=parseFloat(els.landOpacity.value);
    const cW=parseFloat(els.countryWidth.value), aW=parseFloat(els.adminWidth.value);
    const cDashed=els.countryDashed.checked, aDashed=els.adminDashed.checked;

    // 물: light-v11에서 자주 보이는 'water' 계열 우선
    const waterLayers = ['water','water-outline','water-shadow'];
    for(const id of waterLayers){
      if(map.getLayer(id)){
        const t = map.getLayer(id).type;
        if(t==='fill'){ tryPaint(id,'fill-color',sea); tryPaint(id,'fill-opacity',wOp); }
        else if(t==='line'){ tryPaint(id,'line-color',sea); tryPaint(id,'line-opacity',wOp); }
        else if(t==='background'){ tryPaint(id,'background-color',sea); tryPaint(id,'background-opacity',wOp); }
      }
    }

    // 육지: background 우선, 없으면 land/landuse fill에 적용
    const bg = map.getStyle()?.layers?.find(l=>l.type==='background');
    if(bg){ tryPaint(bg.id,'background-color',land); tryPaint(bg.id,'background-opacity',lOp); }
    else {
      const L = map.getStyle()?.layers || [];
      for(const l of L){
        if(l.type==='fill' && /(land|landcover|landuse|earth|natural)/i.test((l.id||'')+' '+(l['source-layer']||''))){
          tryPaint(l.id,'fill-color',land); tryPaint(l.id,'fill-opacity',lOp);
        }
      }
    }

    // 국가/기본 경계 (style 내부)
    const L = map.getStyle()?.layers || [];
    for(const l of L){
      if(l.type==='line' && /(admin|boundary|country)/i.test((l.id||'')+' '+(l['source-layer']||''))){
        tryPaint(l.id,'line-color',bcol);
        tryPaint(l.id,'line-width',cW);
        tryPaint(l.id,'line-dasharray', cDashed ? [2,2] : [1,0]);
      }
    }

    // 우리 행정 라인
    ['sido-line','sigungu-line','emd-line'].forEach(id=>{
      if(map.getLayer(id)){
        tryPaint(id,'line-color',bcol);
        tryPaint(id,'line-width',aW);
        tryPaint(id,'line-dasharray', aDashed ? [2,2] : [1,0]);
      }
    });
  }

  /* ==== PNG 저장 (idle 후 캡처) ==== */
  function savePNG(){
    if(!map) return;
    map.once('idle', ()=>{
      const a=document.createElement('a');
      a.href = map.getCanvas().toDataURL('image/png');
      a.download='map.png';
      a.click();
    });
  }

  // 부팅
  init();
})();
</script>
</body>
</html>
